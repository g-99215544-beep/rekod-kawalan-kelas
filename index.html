<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <title>Rekod Pemantauan Kelas SKSA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#047857" />
  <meta name="description" content="Aplikasi Rekod Pemantauan Kelas SK Sri Aman" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Pemantauan SKSA" />
  <link rel="icon" type="image/png" sizes="192x192" href="app-icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="app-icon-512.png" />
  <link rel="apple-touch-icon" href="app-icon-192.png" />
  <link rel="manifest" href="manifest.json" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;font-family:Poppins,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:0;padding:0}
    html,body{width:100%;min-height:100%;background:#fff;color:#0f172a}
    .app-shell{width:100%;min-height:100vh;padding:0;margin:0;background:#fff}
    .app-card{background:#fff;border-radius:0;padding:28px 24px 34px;box-shadow:none;min-height:100vh;width:100%}
    @media (min-width: 768px){
      html,body{background:#e5ecf4}
      .app-shell{max-width:700px;margin:20px auto;min-height:auto}
      .app-card{border-radius:20px;min-height:auto;box-shadow:0 10px 30px rgba(15,23,42,.18)}
    }
    .logo-wrap{display:flex;flex-direction:column;align-items:center;margin-bottom:12px;position:relative}
    .logo-wrap img{width:80px;height:80px;border-radius:50%;object-fit:cover;cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.25)}
    .logo-wrap h1{margin:10px 0 0;text-align:center;font-size:1.2rem;letter-spacing:.04em;font-weight:600}
    #notifBadge{position:absolute;top:0;right:calc(50% - 50px);background:red;color:#fff;font-size:12px;padding:2px 6px;border-radius:999px;display:none}
    .status-row{display:flex;justify-content:center;gap:10px;font-size:.85rem;color:#4b5563;margin:6px 0 14px;flex-wrap:wrap}
    .status-pill{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;background:#f3f4f6}
    .tab-row{display:inline-flex;border-radius:999px;padding:3px;background:#e5f3ec;margin-bottom:14px}
    .tab-btn{border:none;background:transparent;padding:6px 20px;border-radius:999px;font-size:.85rem;cursor:pointer;font-weight:500;color:#166534}
    .tab-btn.active{background:#059669;color:#fff;box-shadow:0 2px 6px rgba(5,150,105,.45)}
    .input-card{background:#f9fafb;border-radius:16px;padding:14px 12px;border:1px solid #e5e7eb}
    .field{margin-bottom:10px}
    label{font-size:.8rem;font-weight:500;display:flex;align-items:center;gap:6px;margin-bottom:3px;color:#4b5563}
    .required::after{content:" *";color:#e11d48;font-weight:600}
    input[type="text"],input[type="number"],input[type="date"],select,textarea{width:100%;border-radius:10px;border:1px solid #d1d5db;padding:8px 10px;font-size:.9rem;outline:none;background:#fff}
    textarea{resize:vertical;min-height:70px}
    .btn-submit{margin-top:8px;width:100%;border:none;border-radius:999px;padding:10px 16px;font-size:.95rem;font-weight:600;letter-spacing:.04em;background:#047857;color:#fff;cursor:pointer;box-shadow:0 4px 10px rgba(4,120,87,.45)}
    .section-title{margin:16px 0 8px;font-size:.95rem;font-weight:600;color:#111827}
    .toggle-row{display:inline-flex;background:#e5e7eb;border-radius:999px;padding:3px;margin-bottom:10px}
    .toggle-btn{border:none;background:transparent;padding:5px 14px;border-radius:999px;font-size:.8rem;cursor:pointer;font-weight:500;color:#374151}
    .toggle-btn.active{background:#2563eb;color:#fff}
    .btn-secondary{border:1px solid #d1d5db;background:#fff;color:#374151;padding:7px 14px;border-radius:999px;font-size:.8rem;cursor:pointer}
    .btn-small{padding:5px 12px;font-size:.75rem;border-radius:999px;border:none;cursor:pointer}
    .btn-small-primary{background:#047857;color:#fff}
    .btn-small-danger{background:#dc2626;color:#fff}
    .btn-row{margin-top:8px;display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap}
    .inline-count{display:flex;align-items:center;gap:6px}
    .kehadiran-ratio{font-size:.85rem;font-weight:600;color:#047857;white-space:nowrap;padding:4px 8px;border-radius:999px;background:#ecfdf5;border:1px solid #bbf7d0}
    .kehadiran-subtext{margin-top:3px;font-size:.75rem;color:#6b7280}
    .table-wrapper{max-height:none;overflow:auto;margin-top:8px;border-radius:12px;border:1px solid #e5e7eb}
    table{width:100%;border-collapse:collapse;font-size:.78rem}
    thead{background:#047857;color:#fff}
    th,td{padding:6px;border-bottom:1px solid #e5e7eb;text-align:left;vertical-align:top}
    tbody tr:nth-child(even){background:#f9fafb}
    .pill-good{background:#e0f2fe;color:#0369a1;padding:2px 6px;border-radius:999px;font-size:.7rem;font-weight:500}
    .pill-bad{background:#fee2e2;color:#b91c1c;padding:2px 6px;border-radius:999px;font-size:.7rem;font-weight:500}
    .pill-ganti{background:#fef3c7;color:#92400e;padding:2px 6px;border-radius:999px;font-size:.65rem;font-weight:500}
    .pill-mp{padding:2px 6px;border-radius:999px;font-size:.6rem;font-weight:600;display:inline-block;margin-top:2px}
    .pill-bc{background:#dbeafe;color:#1e40af}
    .pill-ba{background:#fce7f3;color:#9d174d}
    .pill-pemulihan{background:#d1fae5;color:#065f46}
    .pill-pemantauan{background:#fef3c7;color:#92400e;font-size:.6rem;padding:2px 4px;border-radius:4px}
    .empty-state{font-size:.8rem;color:#6b7280;margin-top:4px}
    .multi-select{position:relative}
    .multi-select input[readonly]{cursor:pointer;background-color:#eef2ff}
    .multi-dropdown{position:absolute;left:0;right:0;top:calc(100% + 4px);background:#fff;border-radius:12px;border:1px solid #e5e7eb;box-shadow:0 10px 25px rgba(15,23,42,.18);max-height:260px;overflow:auto;z-index:40;padding:6px 8px}
    .multi-option-row{display:flex;align-items:flex-start;gap:6px;padding:3px 2px;font-size:.8rem;cursor:pointer}
    .multi-option-row input{margin-top:2px;flex-shrink:0}
    .multi-option-row span{flex:1;line-height:1.25}
    .multi-footer{margin-top:4px;font-size:.7rem;color:#6b7280;border-top:1px dashed #e5e7eb;padding-top:4px}
    .multi-empty{font-size:.8rem;color:#6b7280;padding:4px 2px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
    .modal-card{background:#fff;border-radius:18px;padding:20px 22px 18px;width:100%;max-width:450px;box-shadow:0 18px 40px rgba(15,23,42,.45);position:relative;max-height:90vh;overflow-y:auto}
    .modal-card h2{margin:0 0 6px 0;font-size:1.1rem;font-weight:600;color:#111827}
    .modal-card p{margin:0 0 14px 0;font-size:.85rem;color:#4b5563}
    .modal-buttons{margin-top:14px;display:flex;justify-content:flex-end;gap:8px}
    .btn-modal-cancel{border-radius:999px;border:none;padding:7px 16px;background:#e5e7eb;color:#374151;font-size:.82rem;cursor:pointer}
    .btn-modal-primary{border-radius:999px;border:none;padding:7px 18px;background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;font-size:.82rem;font-weight:500;cursor:pointer}
    .btn-close-modal{position:absolute;top:12px;right:12px;width:28px;height:28px;border-radius:50%;border:none;background:#f3f4f6;color:#6b7280;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1}
    .btn-close-modal:hover{background:#e5e7eb;color:#111827}
    .install-banner{display:none;position:fixed;bottom:0;left:0;right:0;background:linear-gradient(135deg,#047857,#059669);color:#fff;padding:14px 16px;box-shadow:0 -4px 20px rgba(0,0,0,.2);z-index:999}
    .install-banner.show{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .install-banner-text{font-size:.85rem;flex:1}
    .install-banner-text strong{display:block;font-size:.95rem;margin-bottom:2px}
    .btn-install{background:#fff;color:#047857;border:none;padding:8px 18px;border-radius:999px;font-size:.85rem;font-weight:600;cursor:pointer}
    .btn-dismiss{background:transparent;color:rgba(255,255,255,.8);border:1px solid rgba(255,255,255,.4);padding:6px 12px;border-radius:999px;font-size:.8rem;cursor:pointer}
    .radio-group{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
    .radio-option{display:flex;align-items:center;gap:6px;cursor:pointer}
    .radio-option input[type="radio"]{width:16px;height:16px;cursor:pointer}
    .radio-option label{margin:0;font-size:.85rem;cursor:pointer}
    .mp-field{margin-top:8px;display:none;padding:10px;background:#eff6ff;border-radius:10px;border:1px solid #bfdbfe}
    .mp-field.show{display:block}
    .checkbox-inline{display:flex;align-items:center;gap:8px;margin-top:6px}
    .checkbox-inline input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
    .checkbox-inline label{margin:0;font-size:.85rem;cursor:pointer}
    .catatan-field{margin-top:8px;display:none}
    .catatan-field.show{display:block}
    .catatan-field label{color:#dc2626}
    #allClassSchedule,#pemantauanSchedule{border:2px solid #000}
    #allClassSchedule th,#pemantauanSchedule th{text-align:center;padding:8px 4px;font-size:0.75rem;line-height:1.2;border:2px solid #000}
    #allClassSchedule th .waktu-code,#pemantauanSchedule th .waktu-code{display:block;font-weight:600;font-size:0.8rem}
    #allClassSchedule th .waktu-time,#pemantauanSchedule th .waktu-time{display:block;font-weight:400;font-size:0.65rem;opacity:0.9}
    #allClassSchedule td,#pemantauanSchedule td{text-align:center;padding:6px 3px;font-size:0.7rem;vertical-align:middle;border:2px solid #000;cursor:pointer}
    .cell-empty{background-color:#fef9c3;color:#854d0e}
    .cell-filled{background-color:#fff}
    .cell-multi{background-color:#f0fdf4}
    .cell-rehat{background-color:#059669;color:#fff;font-weight:600;cursor:default!important}
    .cell-pemantauan{background-color:#fef3c7}
    .guru-name{font-weight:600;color:#111827;display:block;font-size:0.7rem}
    .guru-tempat{font-size:0.6rem;color:#6b7280;display:block}
    .guru-ganti-badge{font-size:0.55rem;background:#fbbf24;color:#78350f;padding:1px 3px;border-radius:3px;display:inline-block}
    .multi-record{border-bottom:1px dashed #d1d5db;padding:4px 0;margin-bottom:2px}
    .multi-record:last-child{border-bottom:none;margin-bottom:0}
    .detail-popup .info-row{font-size:0.82rem;color:#374151;margin-bottom:6px;padding:6px 0;border-bottom:1px dashed #e5e7eb}
    .detail-popup .info-row:last-child{border-bottom:none}
    .detail-popup .info-row strong{color:#111827;display:inline-block;min-width:100px}
    .detail-popup .record-section{margin-bottom:12px;padding:12px;background:#f9fafb;border-radius:10px;border-left:4px solid #047857}
    .detail-popup .record-section.bc{border-left-color:#2563eb;background:#eff6ff}
    .detail-popup .record-section.ba{border-left-color:#db2777;background:#fdf2f8}
    .detail-popup .record-section.pemulihan{border-left-color:#059669;background:#ecfdf5}
    .detail-popup .sahsiah-section{margin-top:12px;padding:10px;background:#fef3c7;border-radius:10px}
    .detail-popup .sahsiah-section.baik{background:#dcfce7}
    .detail-popup .sahsiah-section.jahat{background:#fee2e2}
    .detail-popup .pemantauan-section{margin-top:12px;padding:12px;background:#fef3c7;border-radius:10px;border:2px solid #f59e0b}
    .detail-popup .pemantauan-img{max-width:100%;border-radius:8px;margin-top:8px}
    .detail-popup .signature-img{max-width:150px;border:1px solid #e5e7eb;border-radius:4px;margin-top:8px}
    .admin-panel{background:#fef2f2;border-radius:16px;padding:14px;border:2px solid #fecaca;margin-bottom:14px}
    .admin-panel h3{color:#991b1b;font-size:.95rem;margin-bottom:10px}
    .admin-dropdown{width:100%;padding:10px 14px;border-radius:10px;border:2px solid #dc2626;font-size:.9rem;background:#fff;color:#991b1b;font-weight:500;cursor:pointer}
    .admin-content{margin-top:14px;display:none}
    .admin-content.show{display:block}
    .murid-list-editor{background:#fff;border-radius:10px;padding:10px;border:1px solid #e5e7eb;margin-top:10px}
    .murid-item{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #f3f4f6}
    .murid-item:last-child{border-bottom:none}
    .murid-item input{flex:1}
    .signature-pad{border:2px solid #d1d5db;border-radius:10px;background:#fff;touch-action:none}
    .image-upload-area{border:2px dashed #d1d5db;border-radius:10px;padding:20px;text-align:center;cursor:pointer;background:#f9fafb}
    .image-upload-area:hover{border-color:#047857;background:#ecfdf5}
    .image-preview{max-width:100%;border-radius:8px;margin-top:10px}
    .sahsiah-card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
    .sahsiah-card .header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
    .sahsiah-card .badge{font-size:0.7rem;padding:3px 8px;border-radius:999px;font-weight:500}
    .sahsiah-card .badge-baik{background:#dcfce7;color:#166534}
    .sahsiah-card .badge-jahat{background:#fee2e2;color:#991b1b}
    .sahsiah-card .badge-pending{background:#fef3c7;color:#92400e}
    .sahsiah-card .badge-confirmed{background:#dbeafe;color:#1e40af}
    .sahsiah-card .info-row{font-size:0.78rem;color:#4b5563;margin-bottom:4px}
    .sahsiah-card .info-row strong{color:#111827}
    .sahsiah-card .murid-list{font-size:0.75rem;color:#6b7280;background:#f9fafb;padding:6px 8px;border-radius:8px;margin-top:6px}
  </style>
</head>
<body>
<div class="app-shell">
  <div class="app-card">
    <div class="logo-wrap">
      <img id="sksaLogo" src="https://i.imgur.com/AfsVtVG.png" alt="Logo SKSA" />
      <span id="notifBadge">!</span>
      <h1>REKOD PEMANTAUAN KELAS SKSA</h1>
    </div>

    <div class="status-row">
      <div class="status-pill"><span id="headerTarikh">--/--/----</span></div>
      <div class="status-pill"><span id="headerMasa">--:--:--</span></div>
      <div class="status-pill"><span id="headerWaktu">Luar Waktu PdP</span></div>
    </div>

    <!-- Admin Panel (shows after login) -->
    <div class="admin-panel" id="adminPanel" style="display:none;">
      <h3>üîê Panel Admin</h3>
      <select class="admin-dropdown" id="adminFunction">
        <option value="">-- Pilih Fungsi Admin --</option>
        <option value="pemantauan">üìã Pemantauan Pentadbir/Pelawat</option>
        <option value="semak">üìä Semak Rekod</option>
        <option value="sahsiah">üìù Rekod Sahsiah Murid</option>
        <option value="murid">üë• Urus Murid Kelas Pecahan</option>
      </select>
    </div>

    <!-- Sub tabs for Guru -->
    <div class="tab-row" id="guruTabRow">
      <button id="subTabForm" class="tab-btn active">ISI REKOD</button>
      <button id="subTabToday" class="tab-btn">REKOD HARI INI</button>
    </div>

    <!-- ISI REKOD Form -->
    <div id="rekodFormView">
      <div class="input-card">
        <div class="field">
          <label class="required">Nama Guru</label>
          <input type="text" id="namaGuru" placeholder="Contoh: Cikgu Sufian" />
          <div class="checkbox-inline">
            <input type="checkbox" id="guruGanti" />
            <label for="guruGanti">Guru Ganti</label>
          </div>
        </div>
        
        <div class="field">
          <label class="required">Jenis Kelas</label>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" id="jenisKelasP" name="jenisKelas" value="penuh" checked />
              <label for="jenisKelasP">Kelas Penuh</label>
            </div>
            <div class="radio-option">
              <input type="radio" id="jenisKelasC" name="jenisKelas" value="pecahan" />
              <label for="jenisKelasC">Kelas Pecahan</label>
            </div>
          </div>
          <div class="mp-field" id="mpField">
            <label class="required">Mata Pelajaran</label>
            <select id="mataPelajaran">
              <option value="">Sila Pilih</option>
              <option value="BC">Bahasa Cina (BC)</option>
              <option value="BA">Bahasa Arab (BA)</option>
              <option value="PEMULIHAN_BM">Pemulihan BM</option>
              <option value="PEMULIHAN_MT">Pemulihan Matematik</option>
            </select>
          </div>
        </div>
        
        <div class="field">
          <label class="required">Kelas</label>
          <select id="kelas"><option value="">Sila Pilih</option></select>
        </div>
        <div class="field">
          <label class="required">Tempat</label>
          <select id="tempat">
            <option value="">Sila Pilih</option>
            <option value="KELAS">KELAS</option>
            <option value="MAKMAL KOMPUTER">MAKMAL KOMPUTER</option>
            <option value="KANTIN">KANTIN</option>
            <option value="SURAU">SURAU</option>
            <option value="DEWAN">DEWAN</option>
            <option value="BILIK JQAF">BILIK JQAF</option>
            <option value="BILIK MUZIK">BILIK MUZIK</option>
            <option value="BILIK BC">BILIK BC</option>
            <option value="BILIK BA">BILIK BA</option>
            <option value="BILIK PEMULIHAN">BILIK PEMULIHAN</option>
            <option value="LAIN-LAIN">LAIN-LAIN</option>
          </select>
        </div>
        <div class="field">
          <label class="required">Waktu Mengajar</label>
          <select id="waktuMengajar">
            <option value="1">1 Waktu</option>
            <option value="2">2 Waktu</option>
            <option value="3">3 Waktu</option>
            <option value="4">4 Waktu</option>
          </select>
          <div id="waktuPreview" class="kehadiran-subtext">Rekod akan diisi: -</div>
        </div>
        <div class="field">
          <label class="required">Jumlah Murid</label>
          <div class="inline-count">
            <input type="number" id="jumlahMurid" min="0" placeholder="Contoh: 28" />
            <span id="kehadiranRatio" class="kehadiran-ratio">/ -</span>
          </div>
          <div id="kehadiranSubtext" class="kehadiran-subtext">Kehadiran hari ini: -</div>
          <div class="catatan-field" id="catatanField">
            <label class="required">Catatan Keberadaan Murid</label>
            <textarea id="catatanKeberadaan" placeholder="Contoh: Ali - perjumpaan pengawas"></textarea>
          </div>
        </div>
        <button class="btn-submit" id="btnSave">HANTAR</button>
      </div>

      <div class="section-title">Maklumat Sahsiah Murid (tidak wajib)</div>
      <div class="input-card">
        <div class="field">
          <label>Nama Murid</label>
          <div class="multi-select" id="namaMuridWrapper">
            <input type="text" id="namaMuridDisplay" placeholder="Pilih murid yang terlibat" readonly />
            <div id="namaMuridDropdown" class="multi-dropdown" style="display:none;">
              <div id="namaMuridOptions"></div>
              <div class="multi-footer">* Senarai murid berdasarkan kelas yang dipilih.</div>
            </div>
          </div>
        </div>

        <div class="toggle-row">
          <button type="button" class="toggle-btn active" id="btnGood">Amalan Baik</button>
          <button type="button" class="toggle-btn" id="btnBad">Kesalahan Disiplin</button>
        </div>

        <div id="panelGood">
          <div class="field">
            <label>Kategori Amalan Baik</label>
            <select id="amalanBaik">
              <option value="">Sila Pilih</option>
              <option value="Adab dan Berbudi Bahasa">ADAB DAN BERBUDI BAHASA</option>
              <option value="Akhlak Mulia">AKHLAK MULIA</option>
              <option value="Kebersihan Diri & Persekitaran">KEBERSIHAN DIRI & PERSEKITARAN</option>
              <option value="Keselamatan Diri">KESELAMATAN DIRI</option>
            </select>
          </div>
          <div class="field">
            <label>Perincian Amalan</label>
            <select id="perincianAmalan">
              <option value="">Sila Pilih</option>
              <option value="Menghargai Diri">MENGHARGAI DIRI</option>
              <option value="Menghormati Guru & Rakan">MENGHORMATI GURU & RAKAN</option>
              <option value="Berkelakuan Sopan">BERKELAKUAN SOPAN</option>
              <option value="Menjaga Kebersihan Kelas">MENJAGA KEBERSIHAN KELAS</option>
              <option value="Menjalankan Tugas yang Diamanahkan">MENJALANKAN TUGAS YANG DIAMANAHKAN</option>
            </select>
          </div>
          <div class="field">
            <label>Keterangan Amalan</label>
            <textarea id="keteranganAmalan" placeholder="Contoh: Menolong rakan yang kesusahan."></textarea>
          </div>
        </div>

        <div id="panelBad" style="display:none;">
          <div class="field">
            <label>Kategori Kes</label>
            <select id="kategoriKes">
              <option value="">Sila Pilih</option>
              <option value="Barang Larangan">BARANG LARANGAN</option>
              <option value="Kekemasan Diri">KEKEMASAN DIRI</option>
              <option value="Kenakalan">KENAKALAN</option>
              <option value="Ponteng / Lewat Hadir">PONTENG / LEWAT HADIR</option>
              <option value="Kes Khas">KES KHAS</option>
            </select>
          </div>
          <div class="field">
            <label>Punca / Ringkasan</label>
            <input type="text" id="puncaKes" placeholder="Contoh: Membawa telefon bimbit." />
          </div>
          <div class="field">
            <label>Keterangan Kes</label>
            <textarea id="keteranganKes" placeholder="Contoh: Didapati menggunakan telefon dalam kelas."></textarea>
          </div>
        </div>

        <div class="btn-row">
          <button type="button" class="btn-secondary" id="btnClearForm">Reset Semua</button>
        </div>
      </div>
    </div>

    <!-- REKOD HARI INI -->
    <div id="rekodTodayView" style="display:none;">
      <div class="section-title">Jadual Guru Mengikut Waktu (Semua Kelas - Hari Ini)</div>
      <div style="overflow-x:auto;">
        <table id="allClassSchedule"><thead id="allClassHead"><tr><th>Kelas</th></tr></thead><tbody id="allClassBody"><tr><td colspan="14">Loading...</td></tr></tbody></table>
      </div>
      <div style="margin-top:10px;font-size:0.7rem;color:#6b7280;">
        <span class="pill-mp pill-bc">BC</span> Bahasa Cina
        <span class="pill-mp pill-ba">BA</span> Bahasa Arab
        <span class="pill-mp pill-pemulihan">PEM</span> Pemulihan
        <span class="pill-pemantauan">üìã</span> Ada Pemantauan
      </div>
    </div>

    <!-- Admin: Pemantauan -->
    <div id="adminPemantauanView" class="admin-content">
      <div class="section-title">üìã Pemantauan Pentadbir/Pelawat</div>
      <p style="font-size:0.8rem;color:#6b7280;margin-bottom:12px;">Klik pada mana-mana kelas untuk buat laporan pemantauan.</p>
      <div style="overflow-x:auto;">
        <table id="pemantauanSchedule"><thead id="pemantauanHead"><tr><th>Kelas</th></tr></thead><tbody id="pemantauanBody"><tr><td colspan="14">Loading...</td></tr></tbody></table>
      </div>
    </div>
    
    <!-- Admin: Semak Rekod -->
    <div id="adminSemakView" class="admin-content">
      <div class="section-title">üìä Semak Rekod Mengikut Tarikh & Kelas</div>
      <div class="input-card">
        <div class="field">
          <label class="required">Tarikh</label>
          <input type="date" id="semakTarikh" />
        </div>
        <div class="field">
          <label class="required">Kelas</label>
          <select id="semakKelas"><option value="">Sila Pilih</option></select>
        </div>
        <button class="btn-submit" id="btnSemakLoad">SEMAK REKOD</button>
        <div id="semakSummary" class="empty-state" style="margin-top:10px;">Sila pilih tarikh dan kelas.</div>
      </div>
      <div class="table-wrapper" id="semakTableWrapper" style="display:none;margin-top:12px;">
        <table><thead><tr id="semakHeadRow"></tr></thead><tbody><tr id="semakBodyRow"></tr></tbody></table>
      </div>
      <div id="semakDetailCard" class="input-card" style="margin-top:10px;display:none;">
        <div class="section-title" style="margin-top:0;">Butiran Rekod</div>
        <div id="semakDetailContent" style="font-size:.82rem;color:#374151;"></div>
      </div>
    </div>
    
    <!-- Admin: Sahsiah -->
    <div id="adminSahsiahView" class="admin-content">
      <div class="section-title">üìù Rekod Sahsiah Murid</div>
      <div id="adminSahsiahList"><div class="empty-state">Loading...</div></div>
    </div>
    
    <!-- Admin: Urus Murid -->
    <div id="adminMuridView" class="admin-content">
      <div class="section-title">üë• Urus Murid Kelas Pecahan</div>
      <div class="input-card">
        <div class="field">
          <label class="required">Jenis Kelas Pecahan</label>
          <select id="adminMpType">
            <option value="">Sila Pilih</option>
            <option value="BC">Bahasa Cina (BC)</option>
            <option value="BA">Bahasa Arab (BA)</option>
            <option value="PEMULIHAN_BM">Pemulihan BM</option>
            <option value="PEMULIHAN_MT">Pemulihan Matematik</option>
          </select>
        </div>
        <div class="field">
          <label class="required">Kelas</label>
          <select id="adminMpKelas"><option value="">Sila Pilih</option></select>
        </div>
        <button class="btn-submit" id="btnLoadMuridList">MUAT SENARAI</button>
      </div>
      <div id="muridListEditor" class="murid-list-editor" style="display:none;">
        <div class="section-title" style="margin-top:0;">Senarai Murid</div>
        <div id="muridListItems"></div>
        <div class="btn-row" style="margin-top:12px;">
          <button type="button" class="btn-secondary" id="btnAddMurid">+ Tambah Murid</button>
          <button type="button" class="btn-submit" style="width:auto;" id="btnSaveMuridList">SIMPAN</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Admin Login Modal -->
<div id="adminLoginModal" class="modal-backdrop">
  <div class="modal-card">
    <h2>üîê Login Admin</h2>
    <p>Masukkan kata laluan untuk akses panel admin.</p>
    <div class="field"><input type="password" id="adminPassword" placeholder="Kata laluan" /></div>
    <div class="modal-buttons">
      <button type="button" class="btn-modal-cancel" id="adminCancelBtn">Batal</button>
      <button type="button" class="btn-modal-primary" id="adminLoginBtn">Login</button>
    </div>
  </div>
</div>

<!-- Detail Popup Modal -->
<div id="detailPopupModal" class="modal-backdrop">
  <div class="modal-card detail-popup">
    <button type="button" class="btn-close-modal" id="closeDetailPopup">&times;</button>
    <h2 id="detailPopupTitle">Maklumat Rekod</h2>
    <div id="detailPopupContent"></div>
  </div>
</div>

<!-- Pemantauan Form Modal -->
<div id="pemantauanModal" class="modal-backdrop">
  <div class="modal-card">
    <button type="button" class="btn-close-modal" id="closePemantauanModal">&times;</button>
    <h2>üìã Laporan Pemantauan</h2>
    <p id="pemantauanInfo">Kelas: - | Waktu: -</p>
    <div class="field">
      <label class="required">Nama Pemantau</label>
      <input type="text" id="pemantauNama" placeholder="Contoh: En. Ahmad (GPK)" />
    </div>
    <div class="field">
      <label>Catatan Pemantauan</label>
      <textarea id="pemantauCatatan" placeholder="Catatan pemerhatian..."></textarea>
    </div>
    <div class="field">
      <label>Gambar (Bukti)</label>
      <div class="image-upload-area" id="imageUploadArea">
        <div>üì∑ Klik untuk upload gambar</div>
        <input type="file" id="pemantauGambar" accept="image/*" style="display:none" />
      </div>
      <img id="imagePreview" class="image-preview" style="display:none" />
    </div>
    <div class="field">
      <label>Tandatangan</label>
      <canvas id="signaturePad" class="signature-pad" width="300" height="150"></canvas>
      <button type="button" class="btn-secondary" style="margin-top:6px;" id="clearSignature">Padam Tandatangan</button>
    </div>
    <div class="modal-buttons">
      <button type="button" class="btn-modal-cancel" id="cancelPemantauan">Batal</button>
      <button type="button" class="btn-modal-primary" id="savePemantauan">Simpan Laporan</button>
    </div>
  </div>
</div>

<!-- Install Banner -->
<div id="installBanner" class="install-banner">
  <div class="install-banner-text"><strong>Pasang Aplikasi</strong>Muat turun untuk akses lebih pantas</div>
  <button class="btn-install" id="btnInstall">Pasang</button>
  <button class="btn-dismiss" id="btnDismiss">Nanti</button>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="database.js"></script>

<script>
// =====================================================
// GLOBAL VARIABLES
// =====================================================
let isAdminLoggedIn = false;
const ADMIN_PASSWORD = "admin123";
const APPS_SCRIPT_URL = "";

const periods = [
  {code:"W1",start:"7.40",end:"8.10"},{code:"W2",start:"8.10",end:"8.40"},{code:"W3",start:"8.40",end:"9.10"},
  {code:"W4",start:"9.10",end:"9.40"},{code:"W5",start:"9.40",end:"10.10"},{code:"W6",start:"10.10",end:"10.40"},
  {code:"W7",start:"10.40",end:"11.10"},{code:"W8",start:"11.10",end:"11.40"},{code:"W9",start:"11.40",end:"12.10"},
  {code:"W10",start:"12.10",end:"12.40"},{code:"W11",start:"12.40",end:"13.10"},{code:"W12",start:"13.10",end:"13.40"},
  {code:"W13",start:"13.40",end:"14.10"}
];
const TOTAL_WAKTU = 13;

// =====================================================
// HELPER FUNCTIONS
// =====================================================
function getRehatWaktu(kelas) {
  const tahun = kelas.charAt(0);
  if (['1','2','3'].includes(tahun)) return 'W5';
  if (['4','5','6'].includes(tahun)) return 'W7';
  return null;
}

function timeToMinutes(str) {
  const [h, m] = str.split(".").map(Number);
  return h * 60 + m;
}

function formatDate(d) {
  return String(d.getDate()).padStart(2,"0") + "/" + String(d.getMonth()+1).padStart(2,"0") + "/" + d.getFullYear();
}

function formatDateKey(d) {
  return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0");
}

function formatTime(d) {
  return String(d.getHours()).padStart(2,"0") + ":" + String(d.getMinutes()).padStart(2,"0") + ":" + String(d.getSeconds()).padStart(2,"0");
}

function dateInputToKey(val) {
  const parts = val.split("-");
  if (parts.length !== 3) return "";
  const [y, m, d] = parts;
  return d + "/" + m + "/" + y;
}

function getCurrentPeriod(now) {
  const mn = now.getHours() * 60 + now.getMinutes();
  for (const p of periods) {
    const s = timeToMinutes(p.start), e = timeToMinutes(p.end);
    if (mn >= s && mn < e) return p;
  }
  return null;
}

function updateDateTimeUI() {
  const now = new Date();
  document.getElementById("headerTarikh").textContent = formatDate(now);
  document.getElementById("headerMasa").textContent = formatTime(now);
  const p = getCurrentPeriod(now);
  document.getElementById("headerWaktu").textContent = p ? p.code : "Luar Waktu PdP";
  updateWaktuPreview();
}

function updateWaktuPreview() {
  const waktuPreview = document.getElementById("waktuPreview");
  if (!waktuPreview) return;
  const now = new Date();
  const p = getCurrentPeriod(now);
  const waktuMengajar = parseInt(document.getElementById("waktuMengajar")?.value) || 1;
  if (!p) { waktuPreview.textContent = "Rekod akan diisi: Luar waktu PdP"; return; }
  const startIndex = parseInt(p.code.replace('W','')) - 1;
  const waktuList = [];
  for (let i = 0; i < waktuMengajar && (startIndex + i) < TOTAL_WAKTU; i++) waktuList.push("W" + (startIndex + 1 + i));
  waktuPreview.textContent = waktuList.length ? "Rekod akan diisi: " + waktuList.join(", ") : "Rekod akan diisi: -";
  waktuPreview.style.color = "#047857";
}

// =====================================================
// PWA
// =====================================================
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW failed:', err)); });
}
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installBanner').classList.add('show'); });
document.getElementById('btnInstall').addEventListener('click', async () => { if (!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; document.getElementById('installBanner').classList.remove('show'); });
document.getElementById('btnDismiss').addEventListener('click', () => { document.getElementById('installBanner').classList.remove('show'); });

// =====================================================
// NAVIGATION
// =====================================================
const subTabForm = document.getElementById("subTabForm");
const subTabToday = document.getElementById("subTabToday");
const rekodFormView = document.getElementById("rekodFormView");
const rekodTodayView = document.getElementById("rekodTodayView");
const adminPanel = document.getElementById("adminPanel");
const adminFunction = document.getElementById("adminFunction");

function setGuruTab(tab) {
  document.querySelectorAll('.admin-content').forEach(el => el.classList.remove('show'));
  adminFunction.value = "";
  if (tab === "form") {
    subTabForm.classList.add("active"); subTabToday.classList.remove("active");
    rekodFormView.style.display = "block"; rekodTodayView.style.display = "none";
  } else {
    subTabForm.classList.remove("active"); subTabToday.classList.add("active");
    rekodFormView.style.display = "none"; rekodTodayView.style.display = "block";
    loadAllClassesToday();
  }
}

subTabForm.addEventListener("click", () => setGuruTab("form"));
subTabToday.addEventListener("click", () => setGuruTab("today"));

adminFunction.addEventListener("change", function() {
  const val = this.value;
  if (val) { rekodFormView.style.display = "none"; rekodTodayView.style.display = "none"; subTabForm.classList.remove("active"); subTabToday.classList.remove("active"); }
  document.querySelectorAll('.admin-content').forEach(el => el.classList.remove('show'));
  if (val === "pemantauan") { document.getElementById("adminPemantauanView").classList.add("show"); loadPemantauanSchedule(); }
  else if (val === "semak") { document.getElementById("adminSemakView").classList.add("show"); }
  else if (val === "sahsiah") { document.getElementById("adminSahsiahView").classList.add("show"); loadAllSahsiahRecords(); }
  else if (val === "murid") { document.getElementById("adminMuridView").classList.add("show"); }
  else { setGuruTab("form"); }
});

// =====================================================
// JENIS KELAS & SAHSIAH TOGGLE
// =====================================================
const jenisKelasP = document.getElementById("jenisKelasP");
const jenisKelasC = document.getElementById("jenisKelasC");
const mpField = document.getElementById("mpField");
const btnGood = document.getElementById("btnGood");
const btnBad = document.getElementById("btnBad");
const panelGood = document.getElementById("panelGood");
const panelBad = document.getElementById("panelBad");

function updateJenisKelas() { if (jenisKelasC.checked) { mpField.classList.add("show"); } else { mpField.classList.remove("show"); document.getElementById("mataPelajaran").value = ""; } }
jenisKelasP.addEventListener("change", updateJenisKelas);
jenisKelasC.addEventListener("change", updateJenisKelas);

btnGood.addEventListener("click", () => { btnGood.classList.add("active"); btnBad.classList.remove("active"); panelGood.style.display = "block"; panelBad.style.display = "none"; });
btnBad.addEventListener("click", () => { btnBad.classList.add("active"); btnGood.classList.remove("active"); panelBad.style.display = "block"; panelGood.style.display = "none"; });

// =====================================================
// MULTI-SELECT MURID
// =====================================================
const kelasSelect = document.getElementById("kelas");
const namaMuridDisplay = document.getElementById("namaMuridDisplay");
const namaMuridDropdown = document.getElementById("namaMuridDropdown");
const namaMuridOptions = document.getElementById("namaMuridOptions");
const namaMuridWrapper = document.getElementById("namaMuridWrapper");
let selectedMurids = [];

function updateNamaMuridDisplay() {
  if (selectedMurids.length === 0) namaMuridDisplay.value = "";
  else if (selectedMurids.length <= 2) namaMuridDisplay.value = selectedMurids.join(", ");
  else namaMuridDisplay.value = selectedMurids.length + " murid dipilih";
}

function rebuildNamaMuridOptions() {
  selectedMurids = []; updateNamaMuridDisplay(); namaMuridOptions.innerHTML = "";
  const kelasVal = kelasSelect.value.trim();
  if (!kelasVal) { namaMuridOptions.innerHTML = '<div class="multi-empty">Sila pilih kelas.</div>'; return; }
  const isPecahan = jenisKelasC.checked;
  const mp = document.getElementById("mataPelajaran").value;
  let path = "config/classes/classData/" + kelasVal;
  if (isPecahan && mp) path = "config/mp/" + mp + "/" + kelasVal;
  
  db.ref(path).once("value").then(snap => {
    let data = snap.val();
    if (!data && isPecahan && mp) return db.ref("config/classes/classData/" + kelasVal).once("value");
    return Promise.resolve(snap);
  }).then(snap => {
    const data = snap.val();
    if (!data) { namaMuridOptions.innerHTML = '<div class="multi-empty">Tiada data murid.</div>'; return; }
    Object.values(data).forEach(name => {
      const row = document.createElement("label"); row.className = "multi-option-row";
      const cb = document.createElement("input"); cb.type = "checkbox"; cb.value = name;
      cb.addEventListener("change", () => {
        if (cb.checked) { if (!selectedMurids.includes(name)) selectedMurids.push(name); }
        else { selectedMurids = selectedMurids.filter(n => n !== name); }
        updateNamaMuridDisplay();
      });
      const span = document.createElement("span"); span.textContent = name;
      row.appendChild(cb); row.appendChild(span); namaMuridOptions.appendChild(row);
    });
  }).catch(() => { namaMuridOptions.innerHTML = '<div class="multi-empty">Ralat.</div>'; });
}

kelasSelect.addEventListener("change", () => { rebuildNamaMuridOptions(); loadKehadiranForKelas(); });
document.getElementById("mataPelajaran").addEventListener("change", rebuildNamaMuridOptions);
namaMuridDisplay.addEventListener("click", () => { namaMuridDropdown.style.display = namaMuridDropdown.style.display === "none" ? "block" : "none"; });
document.addEventListener("click", e => { if (!namaMuridWrapper.contains(e.target)) namaMuridDropdown.style.display = "none"; });

// =====================================================
// KEHADIRAN
// =====================================================
let presentMuridKelas = 0, totalMuridKelas = 0;

function loadKehadiranForKelas() {
  const kelasVal = kelasSelect.value.trim();
  const ratioEl = document.getElementById("kehadiranRatio");
  const subtextEl = document.getElementById("kehadiranSubtext");
  const catatanField = document.getElementById("catatanField");
  if (!kelasVal) { ratioEl.textContent = "/ -"; subtextEl.textContent = "Kehadiran hari ini: -"; catatanField.classList.remove("show"); presentMuridKelas = 0; totalMuridKelas = 0; return; }
  const today = formatDateKey(new Date());
  db.ref("kehadiran/" + today + "/" + kelasVal).once("value").then(snap => {
    const data = snap.val();
    if (data && data.present !== undefined) { ratioEl.textContent = "/ " + data.present; subtextEl.textContent = "Kehadiran hari ini: " + data.present + "/" + data.total; presentMuridKelas = data.present; totalMuridKelas = data.total; }
    else { ratioEl.textContent = "/ -"; subtextEl.textContent = "Kehadiran hari ini: Tiada data"; presentMuridKelas = 0; totalMuridKelas = 0; }
  });
}

document.getElementById("jumlahMurid").addEventListener("input", function() {
  const jumlah = parseInt(this.value) || 0;
  const catatanField = document.getElementById("catatanField");
  if (presentMuridKelas > 0 && jumlah < presentMuridKelas) catatanField.classList.add("show");
  else catatanField.classList.remove("show");
});

// =====================================================
// FORM & SAVE
// =====================================================
function hasSahsiahData() {
  return !!(selectedMurids.length || document.getElementById("amalanBaik").value || document.getElementById("kategoriKes").value);
}

function clearForm() {
  document.getElementById("namaGuru").value = ""; document.getElementById("guruGanti").checked = false;
  jenisKelasP.checked = true; mpField.classList.remove("show"); document.getElementById("mataPelajaran").value = "";
  kelasSelect.value = ""; document.getElementById("tempat").value = ""; document.getElementById("waktuMengajar").value = "1";
  document.getElementById("jumlahMurid").value = ""; document.getElementById("catatanKeberadaan").value = "";
  document.getElementById("catatanField").classList.remove("show"); selectedMurids = []; updateNamaMuridDisplay(); namaMuridOptions.innerHTML = "";
  document.getElementById("amalanBaik").value = ""; document.getElementById("perincianAmalan").value = ""; document.getElementById("keteranganAmalan").value = "";
  document.getElementById("kategoriKes").value = ""; document.getElementById("puncaKes").value = ""; document.getElementById("keteranganKes").value = "";
  document.getElementById("kehadiranRatio").textContent = "/ -"; document.getElementById("kehadiranSubtext").textContent = "Kehadiran hari ini: -";
  presentMuridKelas = 0; totalMuridKelas = 0; updateWaktuPreview();
}

document.getElementById("btnClearForm").addEventListener("click", clearForm);
document.getElementById("waktuMengajar").addEventListener("change", updateWaktuPreview);

function saveRecordToFirebase(rec) { const key = db.ref("kehadiran").push().key; return db.ref("kehadiran/" + key).set(rec); }
function createSahsiahNotification(record) { db.ref("notifications").push({...record, status:"pending", createdAt:Date.now()}); }

document.getElementById("btnSave").addEventListener("click", () => {
  const namaGuru = document.getElementById("namaGuru").value.trim();
  const guruGanti = document.getElementById("guruGanti").checked;
  const isPecahan = jenisKelasC.checked;
  const mataPelajaran = document.getElementById("mataPelajaran").value;
  const kelas = kelasSelect.value;
  const tempat = document.getElementById("tempat").value;
  const jumlahMurid = document.getElementById("jumlahMurid").value;
  const waktuMengajar = parseInt(document.getElementById("waktuMengajar").value) || 1;
  const catatanKeberadaan = document.getElementById("catatanKeberadaan").value.trim();
  
  if (!namaGuru || !kelas || !tempat || jumlahMurid === "") { alert("Sila lengkapkan semua maklumat wajib."); return; }
  if (isPecahan && !mataPelajaran) { alert("Sila pilih Mata Pelajaran."); return; }
  
  const jumlah = parseInt(jumlahMurid) || 0;
  if (!isPecahan && presentMuridKelas > 0 && jumlah < presentMuridKelas && !catatanKeberadaan) { alert("Sila nyatakan keberadaan murid."); return; }
  
  const now = new Date();
  const p = getCurrentPeriod(now);
  if (!p) { alert("Anda di luar waktu PdP."); return; }
  
  const startIndex = parseInt(p.code.replace('W','')) - 1;
  if (startIndex + waktuMengajar > TOTAL_WAKTU) { alert("Waktu mengajar melebihi had."); return; }
  
  let jenis = null, kategori = "", keterangan = "", namaMuridText = "", namaMuridList = [];
  const adaSahsiah = hasSahsiahData();
  
  if (adaSahsiah) {
    if (selectedMurids.length === 0) { alert("Sila pilih murid untuk rekod sahsiah."); return; }
    namaMuridList = selectedMurids.slice(); namaMuridText = namaMuridList.join(", ");
    if (btnGood.classList.contains("active")) {
      const amalan = document.getElementById("amalanBaik").value;
      if (!amalan) { alert("Sila pilih kategori."); return; }
      jenis = "baik"; kategori = document.getElementById("perincianAmalan").value ? amalan + " - " + document.getElementById("perincianAmalan").value : amalan;
      keterangan = document.getElementById("keteranganAmalan").value.trim();
    } else {
      const kat = document.getElementById("kategoriKes").value;
      if (!kat) { alert("Sila pilih kategori."); return; }
      jenis = "jahat"; kategori = kat;
      keterangan = [document.getElementById("puncaKes").value.trim(), document.getElementById("keteranganKes").value.trim()].filter(Boolean).join(" | ");
    }
  }
  
  const waktuList = [];
  for (let i = 0; i < waktuMengajar; i++) waktuList.push("W" + (startIndex + 1 + i));
  
  const tarikh = formatDate(now), masaRekod = formatTime(now);
  
  const savePromises = waktuList.map(waktuCode => saveRecordToFirebase({
    tarikh, waktu: waktuCode, masaRekod, namaGuru, kelas, tempat, guruGanti,
    jenisKelas: isPecahan ? "pecahan" : "penuh", mataPelajaran: isPecahan ? mataPelajaran : null,
    jumlahMurid: Number(jumlahMurid), presentMurid: presentMuridKelas || null, totalMurid: totalMuridKelas || null,
    waktuMengajar, waktuMula: waktuList[0], waktuAkhir: waktuList[waktuList.length-1],
    catatanKeberadaan: catatanKeberadaan || null, namaMurid: namaMuridText || null,
    namaMuridList: namaMuridList.length ? namaMuridList : null, jenis, kategori, keterangan
  }));
  
  Promise.all(savePromises).then(() => {
    if (adaSahsiah) createSahsiahNotification({tarikh, waktu:waktuList.join(', '), masaRekod, namaGuru, kelas, tempat, namaMurid:namaMuridText, jenis, kategori, keterangan});
    alert("Rekod berjaya disimpan untuk " + waktuList.join(", "));
    clearForm();
  }).catch(() => alert("Gagal simpan rekod."));
});

// =====================================================
// DETAIL POPUP
// =====================================================
const detailPopupModal = document.getElementById("detailPopupModal");
const detailPopupTitle = document.getElementById("detailPopupTitle");
const detailPopupContent = document.getElementById("detailPopupContent");

document.getElementById("closeDetailPopup").addEventListener("click", () => detailPopupModal.style.display = "none");
detailPopupModal.addEventListener("click", (e) => { if (e.target === detailPopupModal) detailPopupModal.style.display = "none"; });

function showDetailPopup(records, kelas, waktu, pemantauanData) {
  detailPopupTitle.textContent = "Maklumat - " + kelas + " (" + waktu + ")";
  let html = '';
  if (records.length === 0) { html = '<div class="info-row">Tiada rekod kawalan kelas.</div>'; }
  else {
    records.forEach((rec, idx) => {
      const mpClass = rec.mataPelajaran === "BC" ? "bc" : rec.mataPelajaran === "BA" ? "ba" : rec.mataPelajaran?.includes("PEMULIHAN") ? "pemulihan" : "";
      html += '<div class="record-section ' + mpClass + '">';
      if (records.length > 1) html += '<div style="font-weight:600;margin-bottom:6px;">üìö Rekod ' + (idx+1) + '</div>';
      html += '<div class="info-row"><strong>üë®‚Äçüè´ Guru:</strong> ' + rec.namaGuru + (rec.guruGanti ? ' <span class="pill-ganti">GANTI</span>' : '') + '</div>';
      html += '<div class="info-row"><strong>üìç Tempat:</strong> ' + rec.tempat + '</div>';
      let kehadiranStr = rec.jumlahMurid + ' murid dalam kelas';
      if (rec.presentMurid && rec.totalMurid) kehadiranStr += ' (Kehadiran: ' + rec.presentMurid + '/' + rec.totalMurid + ')';
      html += '<div class="info-row"><strong>üë• Murid:</strong> ' + kehadiranStr + '</div>';
      if (rec.catatanKeberadaan) html += '<div class="info-row"><strong>üìù Catatan:</strong> ' + rec.catatanKeberadaan + '</div>';
      if (rec.jenis) {
        html += '<div class="sahsiah-section ' + (rec.jenis === 'baik' ? 'baik' : 'jahat') + '">';
        html += '<strong>' + (rec.jenis === 'baik' ? '‚úÖ Amalan Baik' : '‚ö†Ô∏è Kesalahan') + '</strong><br>Kategori: ' + (rec.kategori || '-');
        if (rec.namaMurid) html += '<br>Murid: ' + rec.namaMurid;
        html += '</div>';
      }
      html += '</div>';
    });
  }
  if (pemantauanData) {
    html += '<div class="pemantauan-section">';
    html += '<div style="font-weight:600;margin-bottom:8px;">üìã LAPORAN PEMANTAUAN</div>';
    html += '<div class="info-row"><strong>Pemantau:</strong> ' + pemantauanData.nama + '</div>';
    html += '<div class="info-row"><strong>Masa:</strong> ' + pemantauanData.masa + '</div>';
    if (pemantauanData.catatan) html += '<div class="info-row"><strong>Catatan:</strong> ' + pemantauanData.catatan + '</div>';
    if (pemantauanData.gambarUrl) html += '<img src="' + pemantauanData.gambarUrl + '" class="pemantauan-img" />';
    if (pemantauanData.signature) html += '<div style="margin-top:8px;"><strong>Tandatangan:</strong><br><img src="' + pemantauanData.signature + '" class="signature-img" /></div>';
    html += '</div>';
  }
  detailPopupContent.innerHTML = html;
  detailPopupModal.style.display = "flex";
}

// =====================================================
// LOAD ALL CLASSES TODAY (GURU VIEW)
// =====================================================
let allRecordsToday = {}, allPemantauanToday = {};

function loadAllClassesToday() {
  const head = document.getElementById("allClassHead");
  const body = document.getElementById("allClassBody");
  
  let headerHTML = '<tr style="background:#047857;color:white;"><th style="border:2px solid #000;">Kelas</th>';
  for (let i = 1; i <= TOTAL_WAKTU; i++) {
    const p = periods[i-1];
    headerHTML += '<th style="border:2px solid #000;"><span class="waktu-code">' + p.code + '</span><span class="waktu-time">' + p.start + '</span></th>';
  }
  headerHTML += '</tr>';
  head.innerHTML = headerHTML;
  
  const today = formatDate(new Date());
  body.innerHTML = '<tr><td colspan="' + (TOTAL_WAKTU+1) + '">Loading...</td></tr>';
  
  Promise.all([
    db.ref("config/classes/classData").once("value"),
    db.ref("kehadiran").orderByChild("tarikh").equalTo(today).once("value"),
    db.ref("pemantauan").orderByChild("tarikh").equalTo(today).once("value")
  ]).then(([configSnap, rekodSnap, pemantauanSnap]) => {
    body.innerHTML = "";
    const allClasses = configSnap.val() ? Object.keys(configSnap.val()).sort() : [];
    const kelasMap = {};
    allRecordsToday = {}; allPemantauanToday = {};
    
    allClasses.forEach(kelas => { kelasMap[kelas] = {}; for (let i = 1; i <= TOTAL_WAKTU; i++) kelasMap[kelas]["W"+i] = []; });
    
    if (rekodSnap.exists()) {
      rekodSnap.forEach(child => {
        const rec = child.val();
        if (!rec || !rec.kelas) return;
        if (!kelasMap[rec.kelas]) { kelasMap[rec.kelas] = {}; for (let i = 1; i <= TOTAL_WAKTU; i++) kelasMap[rec.kelas]["W"+i] = []; }
        kelasMap[rec.kelas][rec.waktu].push(rec);
        const key = rec.kelas + "_" + rec.waktu;
        if (!allRecordsToday[key]) allRecordsToday[key] = [];
        allRecordsToday[key].push(rec);
      });
    }
    
    if (pemantauanSnap.exists()) {
      pemantauanSnap.forEach(child => {
        const pem = child.val();
        if (pem && pem.kelas && pem.waktu) allPemantauanToday[pem.kelas + "_" + pem.waktu] = pem;
      });
    }
    
    Object.keys(kelasMap).sort().forEach(kelas => {
      const tr = document.createElement("tr");
      const rehatWaktu = getRehatWaktu(kelas);
      let row = '<td style="font-weight:600;background:#f0fdf4;text-align:center;border:2px solid #000;">' + kelas + '</td>';
      
      for (let i = 1; i <= TOTAL_WAKTU; i++) {
        const waktuKey = "W" + i;
        const records = kelasMap[kelas][waktuKey];
        const pemKey = kelas + "_" + waktuKey;
        const hasPemantauan = !!allPemantauanToday[pemKey];
        
        if (waktuKey === rehatWaktu) {
          row += '<td class="cell-rehat" style="border:2px solid #000;">REHAT</td>';
        } else if (records.length > 0) {
          let cellClass = records.length > 1 ? "cell-multi" : "cell-filled";
          if (hasPemantauan) cellClass += " cell-pemantauan";
          let cellContent = '';
          records.forEach(rec => {
            const mpBadge = rec.mataPelajaran ? '<span class="pill-mp pill-' + (rec.mataPelajaran.includes("PEMULIHAN") ? "pemulihan" : rec.mataPelajaran.toLowerCase()) + '">' + (rec.mataPelajaran.includes("PEMULIHAN") ? "PEM" : rec.mataPelajaran) + '</span>' : '';
            cellContent += '<div class="' + (records.length > 1 ? 'multi-record' : '') + '">';
            cellContent += '<span class="guru-name">' + rec.namaGuru + '</span>';
            cellContent += '<span class="guru-tempat">' + rec.tempat + '</span>' + mpBadge;
            if (hasPemantauan) cellContent += '<span class="pill-pemantauan">üìã</span>';
            cellContent += '</div>';
          });
          row += '<td class="' + cellClass + '" style="border:2px solid #000;" data-kelas="' + kelas + '" data-waktu="' + waktuKey + '">' + cellContent + '</td>';
        } else {
          row += '<td class="cell-empty" style="border:2px solid #000;">-</td>';
        }
      }
      tr.innerHTML = row;
      body.appendChild(tr);
    });
    
    document.querySelectorAll('#allClassBody td[data-kelas]').forEach(td => {
      td.addEventListener('click', function() {
        const kelas = this.dataset.kelas, waktu = this.dataset.waktu, key = kelas + "_" + waktu;
        showDetailPopup(allRecordsToday[key] || [], kelas, waktu, allPemantauanToday[key]);
      });
    });
  }).catch(err => { console.error(err); body.innerHTML = '<tr><td colspan="' + (TOTAL_WAKTU+1) + '">Ralat memuat data</td></tr>'; });
}

// =====================================================
// ADMIN: PEMANTAUAN
// =====================================================
let pemantauanKelas = "", pemantauanWaktu = "";

function loadPemantauanSchedule() {
  const head = document.getElementById("pemantauanHead");
  const body = document.getElementById("pemantauanBody");
  
  let headerHTML = '<tr style="background:#dc2626;color:white;"><th style="border:2px solid #000;">Kelas</th>';
  for (let i = 1; i <= TOTAL_WAKTU; i++) {
    const p = periods[i-1];
    headerHTML += '<th style="border:2px solid #000;"><span class="waktu-code">' + p.code + '</span><span class="waktu-time">' + p.start + '</span></th>';
  }
  headerHTML += '</tr>';
  head.innerHTML = headerHTML;
  
  const today = formatDate(new Date());
  body.innerHTML = '<tr><td colspan="' + (TOTAL_WAKTU+1) + '">Loading...</td></tr>';
  
  Promise.all([
    db.ref("config/classes/classData").once("value"),
    db.ref("kehadiran").orderByChild("tarikh").equalTo(today).once("value")
  ]).then(([configSnap, rekodSnap]) => {
    body.innerHTML = "";
    const allClasses = configSnap.val() ? Object.keys(configSnap.val()).sort() : [];
    const kelasMap = {};
    allClasses.forEach(kelas => { kelasMap[kelas] = {}; for (let i = 1; i <= TOTAL_WAKTU; i++) kelasMap[kelas]["W"+i] = []; });
    
    if (rekodSnap.exists()) {
      rekodSnap.forEach(child => {
        const rec = child.val();
        if (rec && rec.kelas && kelasMap[rec.kelas]) kelasMap[rec.kelas][rec.waktu].push(rec);
      });
    }
    
    Object.keys(kelasMap).sort().forEach(kelas => {
      const tr = document.createElement("tr");
      const rehatWaktu = getRehatWaktu(kelas);
      let row = '<td style="font-weight:600;background:#fef2f2;text-align:center;border:2px solid #000;">' + kelas + '</td>';
      
      for (let i = 1; i <= TOTAL_WAKTU; i++) {
        const waktuKey = "W" + i;
        const records = kelasMap[kelas][waktuKey];
        if (waktuKey === rehatWaktu) {
          row += '<td class="cell-rehat" style="border:2px solid #000;">REHAT</td>';
        } else if (records.length > 0) {
          row += '<td class="cell-filled" style="border:2px solid #000;cursor:pointer;background:#dcfce7;" data-kelas="' + kelas + '" data-waktu="' + waktuKey + '">';
          row += '<span class="guru-name">' + records[0].namaGuru + '</span>';
          row += '<span class="guru-tempat">' + records[0].tempat + '</span>';
          row += '<div style="margin-top:4px;"><button class="btn-small btn-small-primary" style="font-size:0.6rem;padding:3px 6px;">üìã Pantau</button></div>';
          row += '</td>';
        } else {
          row += '<td class="cell-empty" style="border:2px solid #000;">-</td>';
        }
      }
      tr.innerHTML = row;
      body.appendChild(tr);
    });
    
    document.querySelectorAll('#pemantauanBody td[data-kelas]').forEach(td => {
      td.addEventListener('click', function() { pemantauanKelas = this.dataset.kelas; pemantauanWaktu = this.dataset.waktu; openPemantauanModal(); });
    });
  });
}

const pemantauanModal = document.getElementById("pemantauanModal");
const signatureCanvas = document.getElementById("signaturePad");
const signatureCtx = signatureCanvas.getContext("2d");
let isDrawing = false;

function openPemantauanModal() {
  document.getElementById("pemantauanInfo").textContent = "Kelas: " + pemantauanKelas + " | Waktu: " + pemantauanWaktu;
  document.getElementById("pemantauNama").value = "";
  document.getElementById("pemantauCatatan").value = "";
  document.getElementById("imagePreview").style.display = "none";
  document.getElementById("pemantauGambar").value = "";
  signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
  pemantauanModal.style.display = "flex";
}

document.getElementById("closePemantauanModal").addEventListener("click", () => pemantauanModal.style.display = "none");
document.getElementById("cancelPemantauan").addEventListener("click", () => pemantauanModal.style.display = "none");

document.getElementById("imageUploadArea").addEventListener("click", () => document.getElementById("pemantauGambar").click());
document.getElementById("pemantauGambar").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) { const preview = document.getElementById("imagePreview"); preview.src = e.target.result; preview.style.display = "block"; };
    reader.readAsDataURL(file);
  }
});

signatureCanvas.addEventListener("mousedown", (e) => { isDrawing = true; signatureCtx.beginPath(); signatureCtx.moveTo(e.offsetX, e.offsetY); });
signatureCanvas.addEventListener("mousemove", (e) => { if (isDrawing) { signatureCtx.lineTo(e.offsetX, e.offsetY); signatureCtx.stroke(); } });
signatureCanvas.addEventListener("mouseup", () => isDrawing = false);
signatureCanvas.addEventListener("mouseleave", () => isDrawing = false);
signatureCanvas.addEventListener("touchstart", (e) => { e.preventDefault(); isDrawing = true; const rect = signatureCanvas.getBoundingClientRect(); signatureCtx.beginPath(); signatureCtx.moveTo(e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top); });
signatureCanvas.addEventListener("touchmove", (e) => { e.preventDefault(); if (isDrawing) { const rect = signatureCanvas.getBoundingClientRect(); signatureCtx.lineTo(e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top); signatureCtx.stroke(); } });
signatureCanvas.addEventListener("touchend", () => isDrawing = false);
document.getElementById("clearSignature").addEventListener("click", () => signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height));

document.getElementById("savePemantauan").addEventListener("click", async () => {
  const nama = document.getElementById("pemantauNama").value.trim();
  if (!nama) { alert("Sila masukkan nama pemantau."); return; }
  const catatan = document.getElementById("pemantauCatatan").value.trim();
  const signature = signatureCanvas.toDataURL();
  const imagePreview = document.getElementById("imagePreview");
  const gambarBase64 = imagePreview.style.display !== "none" ? imagePreview.src : null;
  
  const now = new Date();
  const pemantauanData = { tarikh: formatDate(now), masa: formatTime(now), kelas: pemantauanKelas, waktu: pemantauanWaktu, nama, catatan, signature, gambarBase64, gambarUrl: gambarBase64, createdAt: Date.now() };
  
  if (APPS_SCRIPT_URL && gambarBase64) {
    try {
      const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ image: gambarBase64, filename: pemantauanKelas + "_" + pemantauanWaktu + "_" + Date.now() }) });
      const result = await response.json();
      if (result.url) pemantauanData.gambarUrl = result.url;
    } catch (err) { console.log("Image upload failed"); }
  }
  
  db.ref("pemantauan").push(pemantauanData).then(() => { alert("Laporan pemantauan berjaya disimpan!"); pemantauanModal.style.display = "none"; loadPemantauanSchedule(); }).catch(() => alert("Gagal simpan laporan."));
});
 btn-small-primary" style="margin-top:8px;">‚úì Sahkan</button>' : '');
      container.appendChild(card);
    });
  });
}

function sahkanLaporan(key) { db.ref("notifications/" + key + "/status").set("confirmed").then(() => loadAllSahsiahRecords()); }
window.sahkanLaporan = sahkanLaporan;

// =====================================================
// ADMIN: URUS MURID KELAS PECAHAN
// =====================================================
const adminMpType = document.getElementById("adminMpType");
const adminMpKelas = document.getElementById("adminMpKelas");
const muridListEditor = document.getElementById("muridListEditor");
const muridListItems = document.getElementById("muridListItems");

document.getElementById("btnLoadMuridList").addEventListener("click", () => {
  const mp = adminMpType.value, kelas = adminMpKelas.value;
  if (!mp || !kelas) { alert("Sila pilih jenis dan kelas."); return; }
  
  db.ref("config/mp/" + mp + "/" + kelas).once("value").then(snap => {
    muridListItems.innerHTML = "";
    const list = Object.values(snap.val() || {});
    if (list.length === 0) muridListItems.innerHTML = '<div class="empty-state">Tiada murid. Klik "Tambah Murid".</div>';
    else list.forEach((nama, idx) => addMuridItem(nama));
    muridListEditor.style.display = "block";
  });
});

function addMuridItem(nama = "") {
  const emptyState = muridListItems.querySelector('.empty-state');
  if (emptyState) emptyState.remove();
  const div = document.createElement("div");
  div.className = "murid-item";
  div.innerHTML = '<input type="text" value="' + nama + '" placeholder="Nama murid" /><button type="button" class="btn-small btn-small-danger" onclick="this.parentElement.remove()">‚úï</button>';
  muridListItems.appendChild(div);
}

document.getElementById("btnAddMurid").addEventListener("click", () => addMuridItem());

document.getElementById("btnSaveMuridList").addEventListener("click", () => {
  const mp = adminMpType.value, kelas = adminMpKelas.value;
  if (!mp || !kelas) return;
  const inputs = muridListItems.querySelectorAll('input');
  const list = {};
  let idx = 0;
  inputs.forEach(input => { const val = input.value.trim(); if (val) { list[idx] = val; idx++; } });
  db.ref("config/mp/" + mp + "/" + kelas).set(list).then(() => alert("Senarai murid berjaya disimpan!")).catch(() => alert("Gagal simpan."));
});

// =====================================================
// LOAD KELAS FROM FIREBASE
// =====================================================
function loadKelasFromFirebase() {
  db.ref("config/classes/classData").once("value").then(snapshot => {
    const data = snapshot.val();
    if (!data) return;
    const classList = Object.keys(data).sort();
    [kelasSelect, semakKelasSelect, adminMpKelas].forEach(sel => {
      if (sel) { sel.innerHTML = '<option value="">Sila Pilih</option>'; classList.forEach(kls => sel.innerHTML += '<option value="' + kls + '">' + kls + '</option>'); }
    });
  });
}

// =====================================================
// ADMIN LOGIN
// =====================================================
const sksaLogo = document.getElementById("sksaLogo");
const adminLoginModal = document.getElementById("adminLoginModal");
const notifBadge = document.getElementById("notifBadge");

sksaLogo.addEventListener("click", () => {
  if (!isAdminLoggedIn) { adminLoginModal.style.display = "flex"; document.getElementById("adminPassword").value = ""; document.getElementById("adminPassword").focus(); }
});

document.getElementById("adminCancelBtn").addEventListener("click", () => adminLoginModal.style.display = "none");

document.getElementById("adminLoginBtn").addEventListener("click", () => {
  if (document.getElementById("adminPassword").value === ADMIN_PASSWORD) {
    isAdminLoggedIn = true;
    adminLoginModal.style.display = "none";
    adminPanel.style.display = "block";
  } else { alert("Kata laluan salah!"); }
});

document.getElementById("adminPassword").addEventListener("keypress", (e) => { if (e.key === "Enter") document.getElementById("adminLoginBtn").click(); });

function listenNotifications() {
  db.ref("notifications").orderByChild("status").equalTo("pending").on("value", snap => {
    if (snap.exists()) { notifBadge.textContent = Object.keys(snap.val()).length; notifBadge.style.display = "block"; }
    else { notifBadge.style.display = "none"; }
  });
}

// =====================================================
// INIT
// =====================================================
document.addEventListener("DOMContentLoaded", () => {
  setInterval(updateDateTimeUI, 1000);
  updateDateTimeUI();
  loadKelasFromFirebase();
  listenNotifications();
  setGuruTab("form");
});
</script>
</body>
</html>
