<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <title>Rekod Pemantauan Kelas SKSA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#047857" />
  <meta name="description" content="Aplikasi Rekod Pemantauan Kelas SK Sri Aman" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Pemantauan SKSA" />
  
  <!-- App Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="app-icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="app-icon-512.png" />
  <link rel="apple-touch-icon" href="app-icon-192.png" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;font-family:Poppins,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:0;padding:0}
    html,body{width:100%;min-height:100%;background:#fff;color:#0f172a}
    .app-shell{width:100%;min-height:100vh;padding:0;margin:0;background:#fff}
    .app-card{background:#fff;border-radius:0;padding:28px 24px 34px;box-shadow:none;min-height:100vh;width:100%}
    @media (min-width: 768px){
      html,body{background:#e5ecf4}
      .app-shell{max-width:500px;margin:20px auto;min-height:auto}
      .app-card{border-radius:20px;min-height:auto;box-shadow:0 10px 30px rgba(15,23,42,.18)}
    }
    .logo-wrap{display:flex;flex-direction:column;align-items:center;margin-bottom:12px;position:relative}
    .logo-wrap img{width:80px;height:80px;border-radius:50%;object-fit:cover;cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.25)}
    .logo-wrap h1{margin:10px 0 0;text-align:center;font-size:1.2rem;letter-spacing:.04em;font-weight:600}
    #notifBadge{position:absolute;top:0;right:0;background:red;color:#fff;font-size:12px;padding:2px 6px;border-radius:999px;display:none}
    .status-row{display:flex;justify-content:center;gap:10px;font-size:.85rem;color:#4b5563;margin:6px 0 14px;flex-wrap:wrap}
    .status-pill{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;background:#f3f4f6}
    .tab-row{display:inline-flex;border-radius:999px;padding:3px;background:#e5f3ec;margin-bottom:14px}
    .tab-btn{border:none;background:transparent;padding:6px 20px;border-radius:999px;font-size:.85rem;cursor:pointer;font-weight:500;color:#166534}
    .tab-btn.active{background:#059669;color:#fff;box-shadow:0 2px 6px rgba(5,150,105,.45)}
    .input-card{background:#f9fafb;border-radius:16px;padding:14px 12px;border:1px solid #e5e7eb}
    .field{margin-bottom:10px}
    label{font-size:.8rem;font-weight:500;display:flex;align-items:center;gap:6px;margin-bottom:3px;color:#4b5563}
    .required::after{content:" *";color:#e11d48;font-weight:600}
    input[type="text"],input[type="number"],input[type="date"],select,textarea{width:100%;border-radius:10px;border:1px solid #d1d5db;padding:8px 10px;font-size:.9rem;outline:none;background:#fff}
    textarea{resize:vertical;min-height:70px}
    .btn-submit{margin-top:8px;width:100%;border:none;border-radius:999px;padding:10px 16px;font-size:.95rem;font-weight:600;letter-spacing:.04em;background:#047857;color:#fff;cursor:pointer;box-shadow:0 4px 10px rgba(4,120,87,.45)}
    .section-title{margin:16px 0 8px;font-size:.95rem;font-weight:600;color:#111827}
    .toggle-row{display:inline-flex;background:#e5e7eb;border-radius:999px;padding:3px;margin-bottom:10px}
    .toggle-btn{border:none;background:transparent;padding:5px 14px;border-radius:999px;font-size:.8rem;cursor:pointer;font-weight:500;color:#374151}
    .toggle-btn.active{background:#2563eb;color:#fff}
    .btn-secondary{border:1px solid #d1d5db;background:#fff;color:#374151;padding:7px 14px;border-radius:999px;font-size:.8rem;cursor:pointer}
    .btn-row{margin-top:8px;display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap}
    .inline-count{display:flex;align-items:center;gap:6px}
    .kehadiran-ratio{font-size:.85rem;font-weight:600;color:#047857;white-space:nowrap;padding:4px 8px;border-radius:999px;background:#ecfdf5;border:1px solid #bbf7d0}
    .kehadiran-subtext{margin-top:3px;font-size:.75rem;color:#6b7280}
    .table-wrapper{max-height:340px;overflow:auto;margin-top:8px;border-radius:12px;border:1px solid #e5e7eb}
    table{width:100%;border-collapse:collapse;font-size:.78rem}
    thead{background:#047857;color:#fff}
    th,td{padding:6px;border-bottom:1px solid #e5e7eb;text-align:left;vertical-align:top}
    tbody tr:nth-child(even){background:#f9fafb}
    .pill-good{background:#e0f2fe;color:#0369a1;padding:2px 6px;border-radius:999px;font-size:.7rem;font-weight:500}
    .pill-bad{background:#fee2e2;color:#b91c1c;padding:2px 6px;border-radius:999px;font-size:.7rem;font-weight:500}
    .empty-state{font-size:.8rem;color:#6b7280;margin-top:4px}
    .multi-select{position:relative}
    .multi-select input[readonly]{cursor:pointer;background-color:#eef2ff}
    .multi-dropdown{position:absolute;left:0;right:0;top:calc(100% + 4px);background:#fff;border-radius:12px;border:1px solid #e5e7eb;box-shadow:0 10px 25px rgba(15,23,42,.18);max-height:260px;overflow:auto;z-index:40;padding:6px 8px}
    .multi-option-row{display:flex;align-items:flex-start;gap:6px;padding:3px 2px;font-size:.8rem;cursor:pointer}
    .multi-option-row input{margin-top:2px;flex-shrink:0}
    .multi-option-row span{flex:1;line-height:1.25}
    .multi-footer{margin-top:4px;font-size:.7rem;color:#6b7280;border-top:1px dashed #e5e7eb;padding-top:4px}
    .multi-empty{font-size:.8rem;color:#6b7280;padding:4px 2px}
    /* Admin modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal-card{background:#fff;border-radius:18px;padding:20px 22px 18px;width:100%;max-width:360px;box-shadow:0 18px 40px rgba(15,23,42,.45)}
    .modal-card h2{margin:0 0 6px 0;font-size:1.1rem;font-weight:600;color:#111827}
    .modal-card p{margin:0 0 14px 0;font-size:.85rem;color:#4b5563}
    .modal-buttons{margin-top:14px;display:flex;justify-content:flex-end;gap:8px}
    .btn-modal-cancel{border-radius:999px;border:none;padding:7px 16px;background:#e5e7eb;color:#374151;font-size:.82rem;cursor:pointer}
    .btn-modal-primary{border-radius:999px;border:none;padding:7px 18px;background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;font-size:.82rem;font-weight:500;cursor:pointer}
    .install-banner{display:none;position:fixed;bottom:0;left:0;right:0;background:linear-gradient(135deg,#047857,#059669);color:#fff;padding:14px 16px;box-shadow:0 -4px 20px rgba(0,0,0,.2);z-index:999}
    .install-banner.show{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .install-banner-text{font-size:.85rem;flex:1}
    .install-banner-text strong{display:block;font-size:.95rem;margin-bottom:2px}
    .btn-install{background:#fff;color:#047857;border:none;padding:8px 18px;border-radius:999px;font-size:.85rem;font-weight:600;cursor:pointer}
    .btn-dismiss{background:transparent;color:rgba(255,255,255,.8);border:1px solid rgba(255,255,255,.4);padding:6px 12px;border-radius:999px;font-size:.8rem;cursor:pointer}
  </style>
</head>
<body>
<div class="app-shell">
  <div class="app-card">
    <div class="logo-wrap">
      <img id="sksaLogo" src="https://i.imgur.com/AfsVtVG.png" alt="Logo SKSA" />
      <span id="notifBadge">!</span>
      <h1>REKOD PEMANTAUAN KELAS SKSA</h1>
    </div>

    <div class="status-row">
      <div class="status-pill"><span id="headerTarikh">--/--/----</span></div>
      <div class="status-pill"><span id="headerMasa">--:--:--</span></div>
      <div class="status-pill"><span id="headerWaktu">Luar Waktu PdP</span></div>
    </div>

    <div class="tab-row">
      <button id="tabRekod" class="tab-btn active">REKOD SEMASA</button>
      <button id="tabSemak" class="tab-btn">SEMAK REKOD</button>
    </div>

    <!-- REKOD SEMASA -->
    <div id="rekodView">
      <!-- Sub tabs -->
      <div class="tab-row" style="margin-top:10px;">
        <button id="subTabForm" class="tab-btn active">ISI REKOD</button>
        <button id="subTabToday" class="tab-btn">REKOD HARI INI</button>
      </div>

      <!-- Form -->
      <div id="rekodFormView">
        <div class="input-card">
          <div class="field">
            <label class="required">Nama Guru</label>
            <input type="text" id="namaGuru" placeholder="Contoh: Cikgu Sufian" />
          </div>
          <div class="field">
            <label class="required">Kelas</label>
            <select id="kelas"><option value="">Sila Pilih</option></select>
          </div>
          <div class="field">
            <label class="required">Tempat</label>
            <select id="tempat">
              <option value="">Sila Pilih</option>
              <option value="KELAS">KELAS</option>
              <option value="MAKMAL KOMPUTER">MAKMAL KOMPUTER</option>
              <option value="KANTIN">KANTIN</option>
              <option value="SURAU">SURAU</option>
              <option value="DEWAN">DEWAN</option>
              <option value="BILIK JQAF">BILIK JQAF</option>
              <option value="BILIK MUZIK">BILIK MUZIK</option>
              <option value="LAIN-LAIN">LAIN-LAIN</option>
            </select>
          </div>
          <div class="field">
            <label class="required">Jumlah Murid</label>
            <div class="inline-count">
              <input type="number" id="jumlahMurid" min="0" placeholder="Contoh: 28" />
              <span id="kehadiranRatio" class="kehadiran-ratio">/ -</span>
            </div>
            <div id="kehadiranSubtext" class="kehadiran-subtext">Kehadiran hari ini: -</div>
          </div>
          <button class="btn-submit" id="btnSave">HANTAR</button>
        </div>

        <div class="section-title">Maklumat Sahsiah Murid (tidak wajib)</div>
        <div class="input-card">
          <div class="field">
            <label>Nama Murid</label>
            <div class="multi-select" id="namaMuridWrapper">
              <input type="text" id="namaMuridDisplay" placeholder="Pilih murid yang terlibat" readonly />
              <div id="namaMuridDropdown" class="multi-dropdown" style="display:none;">
                <div id="namaMuridOptions"></div>
                <div class="multi-footer">* Senarai murid berdasarkan kelas yang dipilih.</div>
              </div>
            </div>
          </div>

          <div class="toggle-row">
            <button type="button" class="toggle-btn active" id="btnGood">Amalan Baik</button>
            <button type="button" class="toggle-btn" id="btnBad">Kesalahan Disiplin</button>
          </div>

          <div id="panelGood">
            <div class="field">
              <label>Kategori Amalan Baik</label>
              <select id="amalanBaik">
                <option value="">Sila Pilih</option>
                <option value="Adab dan Berbudi Bahasa">ADAB DAN BERBUDI BAHASA</option>
                <option value="Akhlak Mulia">AKHLAK MULIA</option>
                <option value="Kebersihan Diri & Persekitaran">KEBERSIHAN DIRI & PERSEKITARAN</option>
                <option value="Keselamatan Diri">KESELAMATAN DIRI</option>
              </select>
            </div>
            <div class="field">
              <label>Perincian Amalan</label>
              <select id="perincianAmalan">
                <option value="">Sila Pilih</option>
                <option value="Menghargai Diri">MENGHARGAI DIRI</option>
                <option value="Menghormati Guru & Rakan">MENGHORMATI GURU & RAKAN</option>
                <option value="Berkelakuan Sopan">BERKELAKUAN SOPAN</option>
                <option value="Menjaga Kebersihan Kelas">MENJAGA KEBERSIHAN KELAS</option>
                <option value="Menjalankan Tugas yang Diamanahkan">MENJALANKAN TUGAS YANG DIAMANAHKAN</option>
              </select>
            </div>
            <div class="field">
              <label>Keterangan Amalan</label>
              <textarea id="keteranganAmalan" placeholder="Contoh: Menolong rakan yang kesusahan tanpa diminta."></textarea>
            </div>
          </div>

          <div id="panelBad" style="display:none;">
            <div class="field">
              <label>Kategori Kes</label>
              <select id="kategoriKes">
                <option value="">Sila Pilih</option>
                <option value="Barang Larangan">BARANG LARANGAN</option>
                <option value="Kekemasan Diri">KEKEMASAN DIRI</option>
                <option value="Kenakalan">KENAKALAN</option>
                <option value="Ponteng / Lewat Hadir">PONTENG / LEWAT HADIR</option>
                <option value="Kes Khas">KES KHAS</option>
                <option value="Kesalahan Asrama">KESALAHAN ASRAMA</option>
              </select>
            </div>
            <div class="field">
              <label>Punca / Ringkasan Salah Laku</label>
              <input type="text" id="puncaKes" placeholder="Contoh: Membawa telefon bimbit tanpa kebenaran." />
            </div>
            <div class="field">
              <label>Keterangan Kes</label>
              <textarea id="keteranganKes" placeholder="Contoh: Didapati menggunakan telefon bimbit di dalam kelas."></textarea>
            </div>
          </div>

          <div class="btn-row">
            <button type="button" class="btn-secondary" id="btnClearForm">Reset Semua</button>
          </div>
        </div>
      </div>

      <!-- Rekod Hari Ini -->
      <div id="rekodTodayView" style="display:none;">
        <div class="section-title">Jadual Guru Mengikut Waktu (Hari Ini)</div>

<h3>Jadual Guru Mengikut Waktu (Semua Kelas - Hari Ini)</h3>
<div style="overflow-x:auto;">
<table id="allClassSchedule" border="1" cellpadding="6" cellspacing="0" style="width:100%; border-collapse:collapse;">
  <thead>
    <tr style="background:#1FA37B; color:white;">
      <th>Kelas</th>
      <th>W1</th><th>W2</th><th>W3</th><th>W4</th>
      <th>W5</th><th>W6</th><th>W7</th><th>W8</th><th>W9</th>
    </tr>
  </thead>
  <tbody id="allClassBody">
    <tr><td colspan="10" style="text-align:center;">Loading...</td></tr>
  </tbody>
</table>
</div>

        <div class="table-wrapper" id="todayTableWrapper">
          <table>
            <thead><tr id="todayHeadRow"></tr></thead>
            <tbody><tr id="todayBodyRow"></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SEMAK REKOD -->
    <div id="semakView" style="display:none;">
      <div class="section-title">Semak Rekod Mengikut Tarikh & Kelas</div>
      <div class="input-card">
        <div class="field">
          <label class="required">Tarikh</label>
          <input type="date" id="semakTarikh" />
        </div>
        <div class="field">
          <label class="required">Kelas</label>
          <select id="semakKelas"><option value="">Sila Pilih</option></select>
        </div>
        <button class="btn-submit" style="margin-top:4px;" id="btnSemakLoad">SEMAK REKOD</button>
        <div id="semakSummary" class="empty-state">Sila pilih tarikh dan kelas untuk semak rekod.</div>
      </div>

      <div class="section-title">Jadual Guru Mengikut Waktu</div>
      <div class="table-wrapper" id="semakTableWrapper" style="display:none;">
        <table>
          <thead><tr id="semakHeadRow"></tr></thead>
          <tbody><tr id="semakBodyRow"></tr></tbody>
        </table>
      </div>

      <div id="semakDetailCard" class="input-card" style="margin-top:10px; display:none;">
        <div class="section-title" style="margin-top:0;">Butiran Rekod</div>
        <div id="semakDetailContent" style="font-size:.82rem;color:#374151;"></div>
      </div>
    </div>
  </div>
</div>


<div id="adminModal" class="modal-backdrop">
  <div class="modal-card">
    <h2>Admin – Laporan Sahsiah</h2>
    <p>Senarai laporan yang perlu tindakan.</p>
    <div id="adminReportList" style="max-height:300px;overflow:auto;"></div>
    <div class="modal-buttons">
      <button type="button" class="btn-modal-cancel" id="btnAdminCancel">Tutup</button>
    </div>
  </div>
</div>

<!-- Install Banner -->
<div id="installBanner" class="install-banner">
  <div class="install-banner-text">
    <strong>Pasang Aplikasi</strong>
    Muat turun untuk akses lebih pantas
  </div>
  <button class="btn-install" id="btnInstall">Pasang</button>
  <button class="btn-dismiss" id="btnDismiss">Nanti</button>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="database.js"></script>

<script>
  // Register Service Worker for PWA
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('Service Worker berjaya didaftarkan:', reg.scope))
        .catch(err => console.log('Service Worker gagal:', err));
    });
  }

  // PWA Install Prompt
  let deferredPrompt;
  const installBanner = document.getElementById('installBanner');
  const btnInstall = document.getElementById('btnInstall');
  const btnDismiss = document.getElementById('btnDismiss');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBanner.classList.add('show');
  });

  btnInstall.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    deferredPrompt = null;
    installBanner.classList.remove('show');
  });

  btnDismiss.addEventListener('click', () => {
    installBanner.classList.remove('show');
  });

  window.addEventListener('appinstalled', () => {
    installBanner.classList.remove('show');
    deferredPrompt = null;
  });
  const periods=[{code:"W1",start:"07:40",end:"08:10"},{code:"W2",start:"08:10",end:"08:40"},{code:"W3",start:"08:40",end:"09:10"},{code:"W4",start:"09:10",end:"09:40"},{code:"W5",start:"09:40",end:"10:10"},{code:"W6",start:"10:10",end:"10:40"},{code:"W7",start:"10:40",end:"11:10"},{code:"W8",start:"11:10",end:"11:40"},{code:"W9",start:"11:40",end:"12:10"},{code:"W10",start:"12:10",end:"12:40"},{code:"W11",start:"12:40",end:"13:10"},{code:"W12",start:"13:10",end:"13:40"}];
  function timeToMinutes(str){const[h,m]=str.split(":").map(Number);return h*60+m}
  function formatDate(d){return String(d.getDate()).padStart(2,"0")+"/"+String(d.getMonth()+1).padStart(2,"0")+"/"+d.getFullYear()}
  function formatTime(d){return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0")+":"+String(d.getSeconds()).padStart(2,"0")}
  function getCurrentPeriod(now){const mn=now.getHours()*60+now.getMinutes();for(const p of periods){const s=timeToMinutes(p.start),e=timeToMinutes(p.end);if(mn>=s&&mn<e)return p}return null}
  function updateDateTimeUI(){const now=new Date();document.getElementById("headerTarikh").textContent=formatDate(now);document.getElementById("headerMasa").textContent=formatTime(now);const p=getCurrentPeriod(now);document.getElementById("headerWaktu").textContent=p?p.code:"Luar Waktu PdP"}
  setInterval(updateDateTimeUI,1000);updateDateTimeUI();

  // Tabs
  const tabRekod=document.getElementById("tabRekod"),tabSemak=document.getElementById("tabSemak"),rekodView=document.getElementById("rekodView"),semakView=document.getElementById("semakView");
  function setTab(tab){if(tab==="rekod"){tabRekod.classList.add("active");tabSemak.classList.remove("active");rekodView.style.display="block";semakView.style.display="none"}else{tabRekod.classList.remove("active");tabSemak.classList.add("active");rekodView.style.display="none";semakView.style.display="block"}}
  tabRekod.addEventListener("click",()=>setTab("rekod"));tabSemak.addEventListener("click",()=>setTab("semak"));

  // Sub tabs
  const subTabForm=document.getElementById("subTabForm"),subTabToday=document.getElementById("subTabToday"),rekodFormView=document.getElementById("rekodFormView"),rekodTodayView=document.getElementById("rekodTodayView");
  function setSubTab(tab){if(tab==="form"){subTabForm.classList.add("active");subTabToday.classList.remove("active");rekodFormView.style.display="block";rekodTodayView.style.display="none"}else{subTabForm.classList.remove("active");subTabToday.classList.add("active");rekodFormView.style.display="none";rekodTodayView.style.display="block";loadTodaySchedule()}}
  subTabForm.addEventListener("click",()=>setSubTab("form"));subTabToday.addEventListener("click",()=>setSubTab("today"));

  // Sahsiah toggle
  const btnGood=document.getElementById("btnGood"),btnBad=document.getElementById("btnBad"),panelGood=document.getElementById("panelGood"),panelBad=document.getElementById("panelBad");
  function setMode(mode){if(mode==="good"){btnGood.classList.add("active");btnBad.classList.remove("active");panelGood.style.display="block";panelBad.style.display="none"}else{btnGood.classList.remove("active");btnBad.classList.add("active");panelGood.style.display="none";panelBad.style.display="block"}}
  btnGood.addEventListener("click",()=>setMode("good"));btnBad.addEventListener("click",()=>setMode("bad"));

  // Multi-select murid
  const kelasSelect=document.getElementById("kelas");
  const namaMuridDisplay=document.getElementById("namaMuridDisplay");
  const namaMuridDropdown=document.getElementById("namaMuridDropdown");
  const namaMuridOptions=document.getElementById("namaMuridOptions");
  const namaMuridWrapper=document.getElementById("namaMuridWrapper");
  let selectedMurids=[];
  function updateNamaMuridDisplay(){if(selectedMurids.length===0){namaMuridDisplay.value=""}else if(selectedMurids.length<=2){namaMuridDisplay.value=selectedMurids.join(", ")}else{namaMuridDisplay.value=selectedMurids.length+" murid dipilih"}}

  function rebuildNamaMuridOptions(){
    selectedMurids=[];updateNamaMuridDisplay();namaMuridOptions.innerHTML="";
    const kelasVal=kelasSelect.value.trim();
    if(!kelasVal){namaMuridOptions.innerHTML='<div class="multi-empty">Sila pilih kelas terlebih dahulu.</div>';return;}
    const path=`config/classes/classData/${kelasVal}`;
    db.ref(path).once("value").then(snap=>{
      const data=snap.val();
      if(!data){namaMuridOptions.innerHTML='<div class="multi-empty">Tiada data murid untuk kelas ini.</div>';return;}
      const senarai=Object.values(data);
      if(!senarai.length){namaMuridOptions.innerHTML='<div class="multi-empty">Tiada data murid untuk kelas ini.</div>';return;}
      senarai.forEach(name=>{
        const row=document.createElement("label");row.className="multi-option-row";
        const cb=document.createElement("input");cb.type="checkbox";cb.value=name;
        cb.addEventListener("change",()=>{if(cb.checked){if(!selectedMurids.includes(name))selectedMurids.push(name)}else{selectedMurids=selectedMurids.filter(n=>n!==name)}updateNamaMuridDisplay();});
        const span=document.createElement("span");span.textContent=name;
        row.appendChild(cb);row.appendChild(span);namaMuridOptions.appendChild(row);
      });
    }).catch(()=>{namaMuridOptions.innerHTML='<div class="multi-empty">Ralat semasa ambil data murid.</div>';});
  }
  kelasSelect.addEventListener("change",rebuildNamaMuridOptions);
  namaMuridDisplay.addEventListener("click",()=>{const h=namaMuridDropdown.style.display==="none"||namaMuridDropdown.style.display==="";namaMuridDropdown.style.display=h?"block":"none"});
  document.addEventListener("click",e=>{if(!namaMuridWrapper.contains(e.target))namaMuridDropdown.style.display="none"});

  function hasSahsiahData(){
    const hasNama=selectedMurids.length>0;
    const amalan=document.getElementById("amalanBaik").value;
    const perincian=document.getElementById("perincianAmalan").value;
    const ketAmalan=document.getElementById("keteranganAmalan").value.trim();
    const kategoriKes=document.getElementById("kategoriKes").value;
    const punca=document.getElementById("puncaKes").value.trim();
    const ketKes=document.getElementById("keteranganKes").value.trim();
    return !!(hasNama||amalan||perincian||ketAmalan||kategoriKes||punca||ketKes);
  }

  function clearForm(){
    document.getElementById("namaGuru").value="";
    kelasSelect.value="";
    document.getElementById("tempat").value="";
    document.getElementById("jumlahMurid").value="";
    selectedMurids=[];updateNamaMuridDisplay();namaMuridOptions.innerHTML="";
    document.getElementById("amalanBaik").value="";
    document.getElementById("perincianAmalan").value="";
    document.getElementById("keteranganAmalan").value="";
    document.getElementById("kategoriKes").value="";
    document.getElementById("puncaKes").value="";
    document.getElementById("keteranganKes").value="";
  }
  document.getElementById("btnClearForm").addEventListener("click",clearForm);

  function saveRecordToFirebase(rec){
    const key=db.ref("kehadiran").push().key;
    return db.ref("kehadiran/"+key).set(rec);
  }

  function createSahsiahNotification(record){
    const notif={
      tarikh:record.tarikh,masa:record.masaRekod,kelas:record.kelas,
      namaGuru:record.namaGuru,namaMurid:record.namaMurid,
      jenis:record.jenis,kategori:record.kategori,keterangan:record.keterangan,
      status:"pending"
    };
    db.ref("notifications").push(notif);
  }

  document.getElementById("btnSave").addEventListener("click",()=>{
    const namaGuru=document.getElementById("namaGuru").value.trim();
    const kelas=kelasSelect.value;
    const tempat=document.getElementById("tempat").value;
    const jumlahMurid=document.getElementById("jumlahMurid").value;
    if(!namaGuru||!kelas||!tempat||jumlahMurid===""){alert("Sila lengkapkan Nama Guru, Kelas, Tempat dan Jumlah Murid.");return;}
    const now=new Date();const tarikh=formatDate(now);const masaRekod=formatTime(now);const p=getCurrentPeriod(now);const waktu=p?p.code:"Luar Waktu PdP";
    let jenis=null,kategori="",keterangan="",namaMuridText="",namaMuridList=[];
    const adaSahsiah=hasSahsiahData();
    if(adaSahsiah){
      if(selectedMurids.length===0){alert("Sila pilih sekurang-kurangnya seorang murid untuk rekod sahsiah.");return;}
      namaMuridList=selectedMurids.slice();namaMuridText=namaMuridList.join(", ");
      const isGood=btnGood.classList.contains("active");
      if(isGood){
        const amalan=document.getElementById("amalanBaik").value;
        if(!amalan){alert("Sila pilih kategori Amalan Baik atau kosongkan semua maklumat sahsiah jika tidak mahu lapor.");return;}
        const perincian=document.getElementById("perincianAmalan").value;
        const ket=document.getElementById("keteranganAmalan").value.trim();
        jenis="baik";kategori=perincian?amalan+" - "+perincian:amalan;keterangan=ket;
      }else{
        const kategoriKes=document.getElementById("kategoriKes").value;
        if(!kategoriKes){alert("Sila pilih Kategori Kes atau kosongkan semua maklumat sahsiah jika tidak mahu lapor.");return;}
        const punca=document.getElementById("puncaKes").value.trim();
        const ketKes=document.getElementById("keteranganKes").value.trim();
        jenis="jahat";kategori=kategoriKes;keterangan=[punca,ketKes].filter(Boolean).join(" | ");
      }
    }
    const newRecord={tarikh,waktu,masaRekod,namaGuru,kelas,tempat,jumlahMurid:Number(jumlahMurid),namaMurid:namaMuridText||null,namaMuridList:namaMuridList.length?namaMuridList:null,jenis,kategori,keterangan};
    saveRecordToFirebase(newRecord).then(()=>{
      if(adaSahsiah) createSahsiahNotification(newRecord);
      alert("Rekod berjaya disimpan ke Firebase.");
      clearForm();
    }).catch(()=>{alert("Gagal simpan rekod. Sila cuba lagi.");});
  });

  // Semak Rekod
  const semakTarikhInput=document.getElementById("semakTarikh"),semakKelasSelect=document.getElementById("semakKelas"),btnSemakLoad=document.getElementById("btnSemakLoad"),semakSummary=document.getElementById("semakSummary"),semakTableWrapper=document.getElementById("semakTableWrapper"),semakHeadRow=document.getElementById("semakHeadRow"),semakBodyRow=document.getElementById("semakBodyRow"),semakDetailCard=document.getElementById("semakDetailCard"),semakDetailContent=document.getElementById("semakDetailContent");
  function dateInputToKey(val){const parts=val.split("-");if(parts.length!==3)return"";const[y,m,d]=parts;return d+"/"+m+"/"+y}
  function buildHeadRow(){semakHeadRow.innerHTML="";periods.forEach(p=>{const th=document.createElement("th");th.innerHTML=p.code+"<br><small>"+p.start+" - "+p.end+"</small>";semakHeadRow.appendChild(th)})}
  buildHeadRow();

  btnSemakLoad.addEventListener("click",()=>{
    const t=semakTarikhInput.value;const k=semakKelasSelect.value;
    if(!t||!k){alert("Sila pilih tarikh dan kelas.");return;}
    const tarikhKey=dateInputToKey(t);
    db.ref("kehadiran").orderByChild("tarikh").equalTo(tarikhKey).once("value").then(snap=>{
      const data=snap.val();
      if(!data){semakSummary.textContent="Tiada rekod dijumpai.";semakTableWrapper.style.display="none";return;}
      const rowsByW={};periods.forEach(p=>rowsByW[p.code]=[]);
      Object.values(data).forEach(rec=>{if(rec.kelas===k&&rowsByW[rec.waktu])rowsByW[rec.waktu].push(rec)});
      semakBodyRow.innerHTML="";periods.forEach(p=>{
        const td=document.createElement("td");const list=rowsByW[p.code];
        if(!list.length){td.textContent="-"}else{
          list.forEach(r=>{
            const div=document.createElement("div");div.style.marginBottom="4px";
            let jenisHtml="-";if(r.jenis==="baik")jenisHtml='<span class="pill-good">Amalan Baik</span>';else if(r.jenis==="jahat")jenisHtml='<span class="pill-bad">Kesalahan</span>';
            div.innerHTML="<strong>"+r.namaGuru+"</strong><br>"+r.tempat+"<br>"+jenisHtml;
            div.style.cursor="pointer";
            div.addEventListener("click",()=>{
              semakDetailCard.style.display="block";
              semakDetailContent.innerHTML="<strong>Guru:</strong> "+r.namaGuru+"<br><strong>Kelas:</strong> "+r.kelas+"<br><strong>Tempat:</strong> "+r.tempat+"<br><strong>Waktu:</strong> "+r.waktu+" ("+p.start+"-"+p.end+")<br><strong>Jumlah Murid:</strong> "+r.jumlahMurid+"<br><strong>Nama Murid:</strong> "+(r.namaMurid||"-")+"<br><strong>Jenis:</strong> "+(r.jenis||"-")+"<br><strong>Kategori:</strong> "+(r.kategori||"-")+"<br><strong>Keterangan:</strong> "+(r.keterangan||"-");
            });
            td.appendChild(div);
          });
        }
        semakBodyRow.appendChild(td);
      });
      semakSummary.textContent="Rekod untuk "+k+" pada "+tarikhKey;semakTableWrapper.style.display="block";
    });
  });

  // Rekod Hari Ini
  function loadTodaySchedule(){
    const kelas=kelasSelect.value;
    if(!kelas){}
    const today=formatDate(new Date());
    const headRow=document.getElementById("todayHeadRow");
    const bodyRow=document.getElementById("todayBodyRow");
    headRow.innerHTML="";bodyRow.innerHTML="";
    periods.forEach(p=>{const th=document.createElement("th");th.innerHTML=p.code+"<br><small>"+p.start+"-"+p.end+"</small>";headRow.appendChild(th)});
    db.ref("kehadiran").orderByChild("tarikh").equalTo(today).once("value").then(snap=>{
      const data=snap.val()||{};const map={};periods.forEach(p=>map[p.code]=[]);
      Object.values(data).forEach(r=>{if(r.kelas===kelas&&map[r.waktu])map[r.waktu].push(r)});
      periods.forEach(p=>{
        const td=document.createElement("td");
        if(map[p.code].length===0){td.textContent="-"}
        else{map[p.code].forEach(r=>{const div=document.createElement("div");div.innerHTML="<strong>"+r.namaGuru+"</strong><br>"+r.tempat;td.appendChild(div);});}
        bodyRow.appendChild(td);
      });
    });
  }

  // Load kelas from Firebase
  function loadKelasFromFirebase(){
    const path="config/classes/classData";
    db.ref(path).once("value").then(snapshot=>{
      const data=snapshot.val();if(!data){console.warn("Tiada data kelas");return;}
      const classList=Object.keys(data).sort();
      kelasSelect.innerHTML='<option value="">Sila Pilih</option>';
      semakKelasSelect.innerHTML='<option value="">Sila Pilih</option>';
      classList.forEach(kls=>{
        const o1=document.createElement("option");o1.value=kls;o1.textContent=kls;kelasSelect.appendChild(o1);
        const o2=document.createElement("option");o2.value=kls;o2.textContent=kls;semakKelasSelect.appendChild(o2);
      });
    }).catch(err=>console.error("Gagal load kelas:",err));
  }

  // Notifications badge
  function listenNotifications(){
    db.ref("notifications").orderByChild("status").equalTo("pending").on("value",snap=>{
      const data=snap.val();const badge=document.getElementById("notifBadge");
      if(data){const count=Object.keys(data).length;badge.textContent=count;badge.style.display="block";}
      else{badge.style.display="none";}
    });
  }

  // Admin modal
  const adminModal=document.getElementById("adminModal");
  const btnAdminCancel=document.getElementById("btnAdminCancel");
  document.getElementById("sksaLogo").addEventListener("click",()=>{
    adminModal.style.display="flex";
    loadSahsiahReports();
  });
  btnAdminCancel.addEventListener("click",()=>adminModal.style.display="none");

  function loadSahsiahReports(){
    const container=document.getElementById("adminReportList");
    container.innerHTML="Loading...";
    db.ref("notifications").orderByChild("status").equalTo("pending").once("value").then(snap=>{
      const data=snap.val();container.innerHTML="";
      if(!data){container.innerHTML="<em>Tiada laporan baharu.</em>";return;}
      Object.entries(data).forEach(([key,r])=>{
        const div=document.createElement("div");
        div.style.border="1px solid #ddd";div.style.padding="8px";div.style.marginBottom="6px";
        div.innerHTML=`<strong>${r.namaGuru}</strong> (${r.kelas})<br>
        Murid: ${r.namaMurid}<br>Jenis: ${r.jenis}<br>Kategori: ${r.kategori}<br>
        <button onclick="sahkanLaporan('${key}')">SAHKAN</button>`;
        container.appendChild(div);
      });
    });
  }

  function sahkanLaporan(key){
    db.ref("notifications/"+key+"/status").set("confirmed").then(()=>{loadSahsiahReports();});
  }
  window.sahkanLaporan=sahkanLaporan;

  document.addEventListener("DOMContentLoaded",()=>{
    loadKelasFromFirebase();
    listenNotifications();
  });
</script>


<div id="adminLoginModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:9999; align-items:center; justify-content:center;">
  <div class="modal-content" style="background:#fff; padding:20px; border-radius:12px; width:320px; text-align:center;">
    <h3>Login Admin</h3>
    <input type="password" id="adminPassword" placeholder="Masukkan kata laluan" style="width:100%; padding:10px; margin:10px 0;" />
    <div style="display:flex; gap:10px; justify-content:center;">
      <button id="adminLoginBtn">Login</button>
      <button onclick="closeAdminLogin()">Batal</button>
    </div>
  </div>
</div>


<script>
// ===== CLEAN ADMIN + BADGE + ALL CLASSES (REBUILT) =====
let isAdminLoggedIn = false;
const ADMIN_PASSWORD = "admin123";

function openAdminLogin(){
  const m = document.getElementById("adminLoginModal");
  if(m) m.style.display = "flex";
}
function closeAdminLogin(){
  const m = document.getElementById("adminLoginModal");
  const p = document.getElementById("adminPassword");
  if(m) m.style.display = "none";
  if(p) p.value = "";
}

// Ensure admin modal functions exist
function openAdminModal(){
  const m = document.getElementById("adminModal");
  if(m) m.style.display = "block";
}
function closeAdminModal(){
  const m = document.getElementById("adminModal");
  if(m) m.style.display = "none";
}

document.addEventListener("DOMContentLoaded", () => {
  // Logo click -> login gate
  const logo = document.getElementById("logo");
  if(logo){
    logo.addEventListener("click", () => {
      if(!isAdminLoggedIn){
        openAdminLogin();
      } else {
        openAdminModal();
      }
    });
  }

  // Login button
  const loginBtn = document.getElementById("adminLoginBtn");
  if(loginBtn){
    loginBtn.addEventListener("click", () => {
      const pass = (document.getElementById("adminPassword")||{}).value || "";
      if(pass === ADMIN_PASSWORD){
        isAdminLoggedIn = true;
        closeAdminLogin();
        openAdminModal();
      } else {
        alert("Kata laluan salah!");
      }
    });
  }

  // Sync notifications for badge & modal list
  if(typeof firebase !== "undefined"){
    firebase.database().ref("notifications").on("value", snap => {
      const badge = document.getElementById("notifBadge");
      const count = snap.numChildren();
      if(badge){
        if(count > 0){
          badge.style.display = "block";
          badge.textContent = count;
        } else {
          badge.style.display = "none";
        }
      }

      const list = document.getElementById("adminList");
      if(list){
        list.innerHTML = "";
        if(!snap.exists()){
          list.innerHTML = "Tiada laporan baharu.";
          return;
        }
        snap.forEach(child => {
          const d = child.val() || {};
          const div = document.createElement("div");
          div.className = "admin-item";
          div.style.borderBottom = "1px solid #e5e7eb";
          div.style.padding = "8px 0";
          div.innerHTML = `<strong>${d.namaMurid || "Tanpa Nama"}</strong><br>${d.kategori || ""} - ${d.perincian || ""}`;
          list.appendChild(div);
        });
      }
    });
  }

  // Load all classes from kehadiran for today
  loadAllClassesToday();
});

function loadAllClassesToday(){
  const body = document.getElementById("allClassBody");
  if(!body || typeof firebase === "undefined") return;

  const today = new Date().toISOString().split("T")[0];

  firebase.database().ref("kehadiran").once("value").then(snapshot => {
    body.innerHTML = "";
    if(!snapshot.exists()){
      body.innerHTML = '<tr><td colspan="10" style="text-align:center;">Tiada data</td></tr>';
      return;
    }

    const kelasMap = {};

    snapshot.forEach(child => {
      const rec = child.val() || {};
      if(rec.tarikh !== today) return;

      const kelas = rec.kelas || "Unknown";
      const waktu = rec.waktu || "W1";

      if(!kelasMap[kelas]) kelasMap[kelas] = {};
      kelasMap[kelas][waktu] = rec.namaGuru || "-";
    });

    const kelasList = Object.keys(kelasMap).sort();
    if(kelasList.length === 0){
      body.innerHTML = '<tr><td colspan="10" style="text-align:center;">Tiada rekod hari ini</td></tr>';
      return;
    }

    kelasList.forEach(kelas => {
      const tr = document.createElement("tr");
      let row = `<td><strong>${kelas}</strong></td>`;
      for(let i=1;i<=9;i++){
        row += `<td>${kelasMap[kelas]["W"+i] || "-"}</td>`;
      }
      tr.innerHTML = row;
      body.appendChild(tr);
    });
  }).catch(err => {
    body.innerHTML = '<tr><td colspan="10" style="text-align:center;">Ralat memuat data</td></tr>';
    console.error("Load all classes error:", err);
  });
}
</script>


<!-- ================= REKOD HARI INI (SEMUA KELAS) ================= -->
<div class="section" id="sectionRekodHariIni" style="display:none; margin-top:12px;">
  <div class="card">
    <h3>Rekod Hari Ini – Semua Kelas</h3>
    <div style="overflow-x:auto;">
      <table border="1" cellpadding="6" cellspacing="0" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="background:#1FA37B; color:white;">
            <th>Kelas</th>
            <th>W1</th><th>W2</th><th>W3</th><th>W4</th>
            <th>W5</th><th>W6</th><th>W7</th><th>W8</th><th>W9</th>
          </tr>
        </thead>
        <tbody id="rekodHariIniBody">
          <tr><td colspan="10" style="text-align:center;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>


<script>
// ===== PATCH: Rekod Hari Ini - Semua Kelas (tanpa pilih kelas) =====
function loadRekodHariIniSemuaKelas() {
  const body = document.getElementById("rekodHariIniBody");
  if (!body || typeof firebase === "undefined") return;

  const today = new Date().toISOString().split("T")[0];
  body.innerHTML = `<tr><td colspan="10" style="text-align:center;">Loading...</td></tr>`;

  firebase.database().ref("kehadiran").once("value").then(snapshot => {
    body.innerHTML = "";

    if (!snapshot.exists()) {
      body.innerHTML = `<tr><td colspan="10" style="text-align:center;">Tiada data</td></tr>`;
      return;
    }

    const kelasMap = {};

    snapshot.forEach(child => {
      const rec = child.val();
      if (!rec || rec.tarikh !== today) return;

      const kelas = rec.kelas || "Unknown";
      const waktu = rec.waktu || "W1";
      const guru = rec.namaGuru || "-";

      if (!kelasMap[kelas]) kelasMap[kelas] = {};
      kelasMap[kelas][waktu] = guru;
    });

    const kelasList = Object.keys(kelasMap).sort();

    if (kelasList.length === 0) {
      body.innerHTML = `<tr><td colspan="10" style="text-align:center;">Tiada rekod hari ini</td></tr>`;
      return;
    }

    kelasList.forEach(kelas => {
      let row = `<tr><td><strong>${kelas}</strong></td>`;
      for (let i = 1; i <= 9; i++) {
        row += `<td>${kelasMap[kelas]["W" + i] || "-"}</td>`;
      }
      row += `</tr>`;
      body.innerHTML += row;
    });
  }).catch(err => {
    console.error("Load Rekod Hari Ini error:", err);
    body.innerHTML = `<tr><td colspan="10" style="text-align:center;">Ralat memuat data</td></tr>`;
  });
}

// Hook to existing Rekod Hari Ini tab button
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("tabRekodHariIni") || document.getElementById("rekodHariIniBtn");
  const sec = document.getElementById("sectionRekodHariIni");
  const isiSec = document.getElementById("sectionIsiRekod");

  if (btn) {
    btn.addEventListener("click", () => {
      if (sec) sec.style.display = "block";
      if (isiSec) isiSec.style.display = "none";
      loadRekodHariIniSemuaKelas();
    });
  }
});
</script>


document.getElementById("rekodHariIniBtn").addEventListener("click", () => {
  const isiSec = document.getElementById("sectionIsiRekod");
  const rekodSec = document.getElementById("sectionRekodHariIni");
  if (isiSec) isiSec.style.display = "none";
  if (rekodSec) rekodSec.style.display = "block";
  if (typeof loadRekodHariIniSemuaKelas === "function") {
    loadRekodHariIniSemuaKelas();
  }
});


<!-- ===== ADMIN LOGIN MODAL ===== -->
<div id="adminLoginModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:12px; width:320px; text-align:center;">
    <h3>Login Admin</h3>
    <input type="password" id="adminPassword" placeholder="Masukkan kata laluan" style="width:100%; padding:10px; margin:10px 0;" />
    <div style="display:flex; gap:10px; justify-content:center;">
      <button id="adminLoginBtn">Login</button>
      <button id="adminCancelBtn">Batal</button>
    </div>
  </div>
</div>

<!-- ===== ADMIN PANEL MODAL ===== -->
<div id="adminPanelModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:12px; width:90%; max-width:400px;">
    <h3>Admin – Laporan Sahsiah</h3>
    <div id="adminList" style="max-height:300px; overflow:auto; margin-top:10px;"></div>
    <div style="text-align:right; margin-top:10px;">
      <button id="adminCloseBtn">Tutup</button>
    </div>
  </div>
</div>


<script>
// ===== CLEAN ADMIN LOGIN + BADGE + TAKE ACTION =====
let isAdminLoggedIn = false;
const ADMIN_PASSWORD = "admin123";

document.addEventListener("DOMContentLoaded", () => {
  const logo = document.getElementById("logo");
  const loginModal = document.getElementById("adminLoginModal");
  const panelModal = document.getElementById("adminPanelModal");
  const loginBtn = document.getElementById("adminLoginBtn");
  const cancelBtn = document.getElementById("adminCancelBtn");
  const closeBtn = document.getElementById("adminCloseBtn");

  if (logo) {
    logo.addEventListener("click", () => {
      if (!isAdminLoggedIn) {
        loginModal.style.display = "flex";
      } else {
        panelModal.style.display = "flex";
      }
    });
  }

  if (cancelBtn) {
    cancelBtn.addEventListener("click", () => {
      loginModal.style.display = "none";
    });
  }

  if (closeBtn) {
    closeBtn.addEventListener("click", () => {
      panelModal.style.display = "none";
    });
  }

  if (loginBtn) {
    loginBtn.addEventListener("click", () => {
      const pass = document.getElementById("adminPassword").value;
      if (pass === ADMIN_PASSWORD) {
        isAdminLoggedIn = true;
        loginModal.style.display = "none";
        panelModal.style.display = "flex";
      } else {
        alert("Kata laluan salah");
      }
    });
  }

  // Firebase notification sync
  if (typeof firebase !== "undefined") {
    firebase.database().ref("notifications").on("value", snap => {
      const badge = document.getElementById("notifBadge");
      const list = document.getElementById("adminList");

      const count = snap.exists() ? snap.numChildren() : 0;

      if (badge) {
        if (count > 0) {
          badge.style.display = "block";
          badge.textContent = count;
        } else {
          badge.style.display = "none";
        }
      }

      if (list) {
        list.innerHTML = "";
        if (!snap.exists()) {
          list.innerHTML = "<p>Tiada laporan baharu.</p>";
          return;
        }

        snap.forEach(child => {
          const key = child.key;
          const d = child.val() || {};
          const div = document.createElement("div");
          div.style.borderBottom = "1px solid #eee";
          div.style.padding = "8px 0";
          div.innerHTML = `
            <strong>${d.namaMurid || "Tanpa Nama"}</strong><br>
            ${d.kategori || ""} - ${d.perincian || ""}<br>
            <button onclick="adminTakeAction('${key}')">Sahkan / Selesai</button>
          `;
          list.appendChild(div);
        });
      }
    });
  }
});

function adminTakeAction(key) {
  if (!key) return;
  firebase.database().ref("notifications/" + key).remove().then(() => {
    alert("Laporan disahkan & dikeluarkan dari senarai.");
  });
}
</script>

</body>
</html>
