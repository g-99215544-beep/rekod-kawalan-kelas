
<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rekod Pemantauan Kelas SKSA</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap">
  <style>
    body { font-family: 'Poppins', sans-serif; margin:0; background:#f4f6f8; }
    .container { max-width: 500px; margin:auto; padding:16px; }
    .logo-wrap { position:relative; display:flex; justify-content:center; margin-top:20px; cursor:pointer; }
    .logo-wrap img { width:90px; }
    #notifBadge {
      position:absolute; top:0; right:calc(50% - 45px);
      background:red; color:white; border-radius:50%;
      padding:4px 7px; font-size:12px; display:none;
    }
    h2 { text-align:center; }
    .tabs button { padding:10px; border:none; border-radius:20px; margin:4px; cursor:pointer; }
    .tab-green { background:#0a8f5c; color:white; }
    .tab-grey { background:#d0d0d0; color:#333; }
    .section { display:none; background:white; padding:12px; border-radius:12px; margin-top:12px; }
    .section.active { display:block; }
    table { width:100%; border-collapse:collapse; font-size:12px; }
    th, td { border:1px solid #ddd; padding:6px; text-align:center; }
    th { background:#0a8f5c; color:white; }
    /* Modal */
    .modal-bg {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4);
      justify-content:center; align-items:center; z-index:9999;
    }
    .modal {
      background:white; padding:20px; border-radius:12px; width:90%; max-width:350px;
    }
    .modal h3 { margin-top:0; }
    .modal input { width:100%; padding:10px; margin:10px 0; }
    .modal button { padding:8px 12px; margin:4px; }
    .report-item { border-bottom:1px solid #eee; padding:8px 0; }
  </style>
</head>
<body>

<div class="container">

  <div class="logo-wrap" id="sksaLogo">
    <img src="app-icon-192.png" alt="SKSA">
    <span id="notifBadge">0</span>
  </div>

  <h2>REKOD PEMANTAUAN KELAS SKSA</h2>

  <div class="tabs">
    <button class="tab-green" onclick="showSection('rekodSemasa')">REKOD SEMASA</button>
    <button class="tab-grey" onclick="showSection('semakRekod')">SEMAK REKOD</button>
  </div>

  <div class="tabs">
    <button class="tab-green" onclick="showSection('isiRekod')">ISI REKOD</button>
    <button class="tab-grey" onclick="showSection('rekodHariIni')">REKOD HARI INI</button>
  </div>

  <div id="isiRekod" class="section active">
    <p><strong>Isi Rekod (demo form)</strong></p>
    <p>Form asal awak boleh kekal di sini.</p>
  </div>

  <div id="rekodHariIni" class="section">
    <h3>Rekod Hari Ini – Semua Kelas</h3>
    <div style="overflow:auto;">
      <table id="tableHariIni">
        <thead>
          <tr>
            <th>Kelas</th>
            <th>W1</th><th>W2</th><th>W3</th><th>W4</th><th>W5</th><th>W6</th><th>W7</th><th>W8</th><th>W9</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<!-- ADMIN LOGIN MODAL -->
<div class="modal-bg" id="adminLoginModal">
  <div class="modal">
    <h3>Login Admin</h3>
    <input type="password" id="adminPassword" placeholder="Masukkan kata laluan">
    <div style="text-align:right;">
      <button onclick="closeAdminLogin()">Batal</button>
      <button onclick="doAdminLogin()">Login</button>
    </div>
  </div>
</div>

<!-- ADMIN PANEL MODAL -->
<div class="modal-bg" id="adminPanelModal">
  <div class="modal">
    <h3>Admin – Laporan Sahsiah</h3>
    <div id="adminReportList"></div>
    <div style="text-align:right;">
      <button onclick="closeAdminPanel()">Tutup</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="database.js"></script>

<script>
// ========== BASIC UI ==========
function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (id === 'rekodHariIni') loadRekodHariIni();
}

// ========== ADMIN LOGIN ==========
let isAdminLoggedIn = false;
const ADMIN_PASSWORD = "admin123";

const logo = document.getElementById("sksaLogo");
const loginModal = document.getElementById("adminLoginModal");
const panelModal = document.getElementById("adminPanelModal");
const badge = document.getElementById("notifBadge");

logo.addEventListener("click", () => {
  if (!isAdminLoggedIn) loginModal.style.display = "flex";
  else openAdminPanel();
});

function closeAdminLogin() { loginModal.style.display = "none"; }
function closeAdminPanel() { panelModal.style.display = "none"; }

function doAdminLogin() {
  const pass = document.getElementById("adminPassword").value;
  if (pass === ADMIN_PASSWORD) {
    isAdminLoggedIn = true;
    loginModal.style.display = "none";
    openAdminPanel();
  } else {
    alert("Kata laluan salah");
  }
}

function openAdminPanel() {
  panelModal.style.display = "flex";
  loadAdminReports();
}

// ========== ADMIN REPORTS + BADGE ==========
function loadAdminReports() {
  const list = document.getElementById("adminReportList");
  list.innerHTML = "Loading...";

  firebase.database().ref("notifications").on("value", snap => {
    list.innerHTML = "";
    if (!snap.exists()) {
      list.innerHTML = "<em>Tiada laporan baharu.</em>";
      badge.style.display = "none";
      return;
    }

    const count = snap.numChildren();
    badge.textContent = count;
    badge.style.display = "block";

    snap.forEach(child => {
      const key = child.key;
      const d = child.val();
      const div = document.createElement("div");
      div.className = "report-item";
      div.innerHTML = `
        <strong>${d.namaGuru || ''}</strong> (${d.kelas || ''})<br>
        Murid: ${d.namaMurid || ''}<br>
        Jenis: ${d.jenis || ''}<br>
        Kategori: ${d.kategori || ''}<br>
        <button onclick="sahkanLaporan('${key}')">SAHKAN</button>
      `;
      list.appendChild(div);
    });
  });
}

function sahkanLaporan(key) {
  firebase.database().ref("notifications/" + key).remove();
}

// ========== REKOD HARI INI – SEMUA KELAS ==========
function loadRekodHariIni() {
  const tbody = document.querySelector("#tableHariIni tbody");
  tbody.innerHTML = "Loading...";

  const today = new Date().toISOString().slice(0,10);

  firebase.database().ref("kehadiran").once("value").then(snap => {
    tbody.innerHTML = "";
    if (!snap.exists()) {
      tbody.innerHTML = "<tr><td colspan='10'>Tiada data</td></tr>";
      return;
    }

    const dataByClass = {};

    snap.forEach(child => {
      const d = child.val();
      if (!d.tarikh || d.tarikh !== today) return;

      const kelas = d.kelas || "UNKNOWN";
      if (!dataByClass[kelas]) dataByClass[kelas] = {};
      dataByClass[kelas][d.waktu] = d.namaGuru || "-";
    });

    Object.keys(dataByClass).forEach(kelas => {
      const tr = document.createElement("tr");
      let html = `<td>${kelas}</td>`;
      for (let i=1; i<=9; i++) {
        html += `<td>${dataByClass[kelas]['W'+i] || '-'}</td>`;
      }
      tr.innerHTML = html;
      tbody.appendChild(tr);
    });
  });
}

// ========== BADGE INIT ==========
firebase.database().ref("notifications").on("value", snap => {
  if (!snap.exists()) {
    badge.style.display = "none";
  } else {
    badge.textContent = snap.numChildren();
    badge.style.display = "block";
  }
});
</script>

</body>
</html>
