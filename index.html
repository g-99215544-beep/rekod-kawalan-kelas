<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <title>Rekod Kawalan Murid SKSA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#047857">
  <link rel="icon" type="image/png" sizes="192x192" href="./app-icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="./app-icon-512.png">
  <link rel="apple-touch-icon" href="./app-icon-192.png">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box;font-family:Poppins,system-ui}
    body{margin:0;background:#e5ecf4;color:#0f172a}
    .app-shell{max-width:480px;margin:12px auto;padding:8px}
    .app-card{background:#fff;border-radius:20px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .logo-wrap{text-align:center;position:relative}
    .logo-wrap img{width:90px;height:90px;border-radius:16px;cursor:pointer}
    #notifBadge{position:absolute;top:0;right:35%;background:red;color:white;font-size:12px;padding:2px 6px;border-radius:999px;display:none}
    h1{text-align:center;font-size:1.1rem;margin:8px 0}
    .tab-row{display:flex;gap:6px;margin-bottom:10px}
    .tab-btn{flex:1;border:none;padding:8px;border-radius:999px;background:#e5e7eb;cursor:pointer;font-weight:500}
    .tab-btn.active{background:#047857;color:white}
    .input-card{background:#f9fafb;border-radius:16px;padding:14px;margin-bottom:10px}
    .field{margin-bottom:8px}
    label{font-size:.8rem;font-weight:500}
    input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid #ccc}
    button{padding:10px;border:none;border-radius:999px;background:#047857;color:white;cursor:pointer;width:100%}
    table{width:100%;border-collapse:collapse;font-size:.75rem}
    th,td{border:1px solid #ddd;padding:4px;text-align:left}
    .multi-dropdown{background:white;border:1px solid #ccc;max-height:150px;overflow:auto;border-radius:10px}
    .multi-option-row{display:flex;gap:6px;padding:4px;font-size:.8rem;cursor:pointer}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:999}
    .modal-card{background:white;padding:16px;border-radius:16px;width:90%;max-width:350px}
  </style>
</head>

<body>
<div class="app-shell">
  <div class="app-card">

    <div class="logo-wrap">
      <img id="sksaLogo" src="./app-icon-192.png">
      <span id="notifBadge">!</span>
      <h1>REKOD KAWALAN MURID SKSA</h1>
    </div>

    <div class="tab-row">
      <button id="tabRekod" class="tab-btn active">REKOD</button>
      <button id="tabSemak" class="tab-btn">SEMAK</button>
    </div>

    <!-- REKOD -->
    <div id="rekodView">

      <div class="tab-row">
        <button id="subTabForm" class="tab-btn active">ISI REKOD</button>
        <button id="subTabToday" class="tab-btn">REKOD HARI INI</button>
      </div>

      <div id="rekodFormView">

        <div class="input-card">
          <div class="field"><label>Nama Guru</label><input id="namaGuru"></div>
          <div class="field"><label>Kelas</label><select id="kelas"></select></div>
          <div class="field"><label>Tempat</label>
            <select id="tempat">
              <option value="">PILIH</option>
              <option>KELAS</option><option>KANTIN</option><option>SURAU</option><option>DEWAN</option>
            </select>
          </div>
          <div class="field"><label>Jumlah Murid</label><input id="jumlahMurid" type="number"></div>
          <button id="btnSave">HANTAR</button>
        </div>

        <div class="input-card">
          <div class="field">
            <label>Nama Murid</label>
            <input id="namaMuridDisplay" readonly placeholder="Klik untuk pilih murid">
            <div id="namaMuridDropdown" class="multi-dropdown" style="display:none"></div>
          </div>

          <div class="tab-row">
            <button id="btnGood" class="tab-btn active">AMALAN BAIK</button>
            <button id="btnBad" class="tab-btn">KES DISIPLIN</button>
          </div>

          <div id="panelGood">
            <input id="amalanBaik" placeholder="Kategori Amalan Baik">
            <textarea id="keteranganAmalan" placeholder="Keterangan Amalan"></textarea>
          </div>

          <div id="panelBad" style="display:none">
            <input id="kategoriKes" placeholder="Kategori Kes">
            <textarea id="keteranganKes" placeholder="Keterangan Kes"></textarea>
          </div>
        </div>

      </div>

      <div id="rekodTodayView" style="display:none">
        <h3>Jadual Guru Hari Ini</h3>
        <table>
          <thead><tr id="todayHeadRow"></tr></thead>
          <tbody><tr id="todayBodyRow"></tr></tbody>
        </table>
      </div>

    </div>

    <!-- SEMAK -->
    <div id="semakView" style="display:none">
      <div class="input-card">
        <input type="date" id="semakTarikh">
        <select id="semakKelas"></select>
        <button id="btnSemakLoad">SEMAK</button>
      </div>
      <table>
        <thead><tr id="semakHeadRow"></tr></thead>
        <tbody><tr id="semakBodyRow"></tr></tbody>
      </table>
    </div>

  </div>
</div>

<!-- ADMIN MODAL -->
<div id="adminModal" class="modal-backdrop">
  <div class="modal-card">
    <h3>Laporan Sahsiah</h3>
    <div id="adminReportList"></div>
    <button onclick="document.getElementById('adminModal').style.display='none'">TUTUP</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="./database.js"></script>

<script>
/* ===== PWA INSTALL ===== */
let deferredPrompt;
window.addEventListener("beforeinstallprompt", (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  setTimeout(()=>{
    if(deferredPrompt) deferredPrompt.prompt();
  },1500);
});

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js");
}

/* ===== UI ===== */
const periods=["W1","W2","W3","W4","W5","W6","W7","W8","W9","W10","W11","W12"];
const tabRekod=document.getElementById("tabRekod");
const tabSemak=document.getElementById("tabSemak");
const rekodView=document.getElementById("rekodView");
const semakView=document.getElementById("semakView");

tabRekod.onclick=()=>{rekodView.style.display="block";semakView.style.display="none";};
tabSemak.onclick=()=>{rekodView.style.display="none";semakView.style.display="block";};

const subTabForm=document.getElementById("subTabForm");
const subTabToday=document.getElementById("subTabToday");
const rekodFormView=document.getElementById("rekodFormView");
const rekodTodayView=document.getElementById("rekodTodayView");

subTabForm.onclick=()=>{rekodFormView.style.display="block";rekodTodayView.style.display="none";};
subTabToday.onclick=()=>{rekodFormView.style.display="none";rekodTodayView.style.display="block";loadToday();};

const btnGood=document.getElementById("btnGood");
const btnBad=document.getElementById("btnBad");
const panelGood=document.getElementById("panelGood");
const panelBad=document.getElementById("panelBad");

btnGood.onclick=()=>{panelGood.style.display="block";panelBad.style.display="none";};
btnBad.onclick=()=>{panelGood.style.display="none";panelBad.style.display="block";};

const kelasSelect=document.getElementById("kelas");
const semakKelas=document.getElementById("semakKelas");
const namaMuridDisplay=document.getElementById("namaMuridDisplay");
const namaMuridDropdown=document.getElementById("namaMuridDropdown");

let selectedMurids=[];

/* ===== LOAD KELAS ===== */
db.ref("config/classes/classData").once("value").then(snap=>{
  const data=snap.val()||{};
  kelasSelect.innerHTML='<option value="">PILIH</option>';
  semakKelas.innerHTML='<option value="">PILIH</option>';
  Object.keys(data).forEach(k=>{
    kelasSelect.innerHTML+=`<option value="${k}">${k}</option>`;
    semakKelas.innerHTML+=`<option value="${k}">${k}</option>`;
  });
});

/* ===== LOAD MURID ===== */
kelasSelect.onchange=()=>{
  selectedMurids=[];
  namaMuridDisplay.value="";
  namaMuridDropdown.innerHTML="";
  if(!kelasSelect.value) return;

  db.ref("config/classes/classData/"+kelasSelect.value).once("value").then(snap=>{
    const list=Object.values(snap.val()||{});
    list.forEach(n=>{
      const div=document.createElement("div");
      div.className="multi-option-row";
      div.textContent=n;
      div.onclick=()=>{
        if(!selectedMurids.includes(n)){
          selectedMurids.push(n);
          namaMuridDisplay.value=selectedMurids.join(", ");
        }
      };
      namaMuridDropdown.appendChild(div);
    });
  });
};

namaMuridDisplay.onclick=()=>{
  namaMuridDropdown.style.display = namaMuridDropdown.style.display==="block"?"none":"block";
};

/* ===== SAVE ===== */
document.getElementById("btnSave").onclick=()=>{
  const record={
    namaGuru:document.getElementById("namaGuru").value,
    kelas:kelasSelect.value,
    tempat:document.getElementById("tempat").value,
    jumlah:document.getElementById("jumlahMurid").value,
    murid:selectedMurids.join(", "),
    jenis:panelGood.style.display==="block"?"baik":"kes",
    tarikh:new Date().toLocaleDateString()
  };

  db.ref("kehadiran").push(record);

  if(selectedMurids.length>0){
    db.ref("notifications").push({...record,status:"pending"});
  }

  alert("Rekod berjaya disimpan");
};

/* ===== NOTIFICATION BADGE ===== */
db.ref("notifications").orderByChild("status").equalTo("pending").on("value",snap=>{
  const badge=document.getElementById("notifBadge");
  if(snap.exists()){
    badge.style.display="block";
    badge.textContent=Object.keys(snap.val()).length;
  } else {
    badge.style.display="none";
  }
});

/* ===== ADMIN ===== */
document.getElementById("sksaLogo").onclick=()=>{
  document.getElementById("adminModal").style.display="flex";
  loadAdmin();
};

function loadAdmin(){
  const box=document.getElementById("adminReportList");
  box.innerHTML="";
  db.ref("notifications").orderByChild("status").equalTo("pending").once("value").then(snap=>{
    snap.forEach(child=>{
      const d=child.val();
      const div=document.createElement("div");
      div.innerHTML=`<b>${d.namaGuru}</b><br>${d.murid}<br><button onclick="sahkan('${child.key}')">SAHKAN</button><hr>`;
      box.appendChild(div);
    });
  });
}

function sahkan(key){
  db.ref("notifications/"+key+"/status").set("confirmed");
  loadAdmin();
}

/* ===== REKOD HARI INI ===== */
function loadToday(){
  const head=document.getElementById("todayHeadRow");
  const body=document.getElementById("todayBodyRow");
  head.innerHTML=""; body.innerHTML="";
  periods.forEach(p=>head.innerHTML+=`<th>${p}</th>`);
  periods.forEach(p=>body.innerHTML+=`<td>-</td>`);
}
</script>

</body>
</html>
