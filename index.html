<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <title>Rekod Pemantauan Kelas SKSA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes" />
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#047857" />
  <meta name="description" content="Aplikasi Rekod Pemantauan Kelas SK Sri Aman" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Pemantauan SKSA" />
  
  <!-- App Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="app-icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="app-icon-512.png" />
  <link rel="apple-touch-icon" href="app-icon-192.png" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;font-family:Poppins,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:0;padding:0}
    html,body{width:100%;min-height:100%;background:#fff;color:#0f172a}
    .app-shell{width:100%;min-height:100vh;padding:0;margin:0;background:#fff}
    .app-card{background:#fff;border-radius:0;padding:28px 24px 34px;box-shadow:none;min-height:100vh;width:100%}
    @media (min-width: 768px){
      html,body{background:#e5ecf4}
      .app-shell{max-width:700px;margin:20px auto;min-height:auto}
      .app-card{border-radius:20px;min-height:auto;box-shadow:0 10px 30px rgba(15,23,42,.18)}
    }
    .logo-wrap{display:flex;flex-direction:column;align-items:center;margin-bottom:12px;position:relative}
    .logo-wrap img{width:80px;height:80px;border-radius:50%;object-fit:cover;cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.25)}
    .logo-wrap h1{margin:10px 0 0;text-align:center;font-size:1.2rem;letter-spacing:.04em;font-weight:600}
    #notifBadge{position:absolute;top:0;right:calc(50% - 50px);background:red;color:#fff;font-size:12px;padding:2px 6px;border-radius:999px;display:none;border:2px solid #fff;}
    .status-row{display:flex;justify-content:center;gap:10px;font-size:.85rem;color:#4b5563;margin:6px 0 14px;flex-wrap:wrap}
    .status-pill{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;background:#f3f4f6}
    
    /* Sub Tabs (Isi Rekod vs Rekod Hari Ini) */
    .tab-row{display:inline-flex;border-radius:999px;padding:3px;background:#e5f3ec;margin-bottom:14px; width: 100%; justify-content: center;}
    .tab-btn{border:none;background:transparent;padding:6px 20px;border-radius:999px;font-size:.85rem;cursor:pointer;font-weight:500;color:#166534; flex: 1; text-align: center;}
    .tab-btn.active{background:#059669;color:#fff;box-shadow:0 2px 6px rgba(5,150,105,.45)}
    
    /* Admin Header */
    .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #fee2e2; padding: 10px 15px; border-radius: 12px; border: 1px solid #fecaca; }
    .admin-title { font-weight: 600; color: #b91c1c; display: flex; align-items: center; gap: 6px; }
    .btn-exit-admin { background: #fff; border: 1px solid #b91c1c; color: #b91c1c; padding: 4px 12px; border-radius: 999px; font-size: 0.75rem; font-weight: 600; cursor: pointer; }
    
    /* Admin Dropdown */
    .admin-controls { margin-bottom: 20px; }
    .admin-controls label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #111827; }
    .admin-select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #d1d5db; font-size: 1rem; background-color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); outline: none; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; }

    .input-card{background:#f9fafb;border-radius:16px;padding:14px 12px;border:1px solid #e5e7eb}
    .field{margin-bottom:10px}
    label{font-size:.8rem;font-weight:500;display:flex;align-items:center;gap:6px;margin-bottom:3px;color:#4b5563}
    .required::after{content:" *";color:#e11d48;font-weight:600}
    input[type="text"],input[type="number"],input[type="date"],select,textarea{width:100%;border-radius:10px;border:1px solid #d1d5db;padding:8px 10px;font-size:.9rem;outline:none;background:#fff}
    textarea{resize:vertical;min-height:70px}
    .btn-submit{margin-top:8px;width:100%;border:none;border-radius:999px;padding:10px 16px;font-size:.95rem;font-weight:600;letter-spacing:.04em;background:#047857;color:#fff;cursor:pointer;box-shadow:0 4px 10px rgba(4,120,87,.45)}
    .section-title{margin:16px 0 8px;font-size:.95rem;font-weight:600;color:#111827}
    .toggle-row{display:inline-flex;background:#e5e7eb;border-radius:999px;padding:3px;margin-bottom:10px}
    .toggle-btn{border:none;background:transparent;padding:5px 14px;border-radius:999px;font-size:.8rem;cursor:pointer;font-weight:500;color:#374151}
    .toggle-btn.active{background:#2563eb;color:#fff}
    .btn-secondary{border:1px solid #d1d5db;background:#fff;color:#374151;padding:7px 14px;border-radius:999px;font-size:.8rem;cursor:pointer}
    .btn-row{margin-top:8px;display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap}
    .inline-count{display:flex;align-items:center;gap:6px}
    .kehadiran-ratio{font-size:.85rem;font-weight:600;color:#047857;white-space:nowrap;padding:4px 8px;border-radius:999px;background:#ecfdf5;border:1px solid #bbf7d0}
    .kehadiran-subtext{margin-top:3px;font-size:.75rem;color:#6b7280}
    .table-wrapper{max-height:none;overflow:auto;margin-top:8px;border-radius:12px;border:1px solid #e5e7eb}
    table{width:100%;border-collapse:collapse;font-size:.78rem}
    thead{background:#047857;color:#fff}
    th,td{padding:6px;border-bottom:1px solid #e5e7eb;text-align:left;vertical-align:top}
    tbody tr:nth-child(even){background:#f9fafb}
    .pill-good{background:#e0f2fe;color:#0369a1;padding:2px 6px;border-radius:999px;font-size:.7rem;font-weight:500}
    .pill-bad{background:#fee2e2;color:#b91c1c;padding:2px 6px;border-radius:999px;font-size:.7rem;font-weight:500}
    .pill-ganti{background:#fef3c7;color:#92400e;padding:2px 6px;border-radius:999px;font-size:.65rem;font-weight:500}
    .pill-mp{padding:2px 6px;border-radius:999px;font-size:.6rem;font-weight:600;display:inline-block;margin-top:2px}
    .pill-bc{background:#dbeafe;color:#1e40af}
    .pill-ba{background:#fce7f3;color:#9d174d}
    .pill-pemulihan{background:#d1fae5;color:#065f46}
    .empty-state{font-size:.8rem;color:#6b7280;margin-top:4px}
    .multi-select{position:relative}
    .multi-select input[readonly]{cursor:pointer;background-color:#eef2ff}
    .multi-dropdown{position:absolute;left:0;right:0;top:calc(100% + 4px);background:#fff;border-radius:12px;border:1px solid #e5e7eb;box-shadow:0 10px 25px rgba(15,23,42,.18);max-height:260px;overflow:auto;z-index:40;padding:6px 8px}
    .multi-option-row{display:flex;align-items:flex-start;gap:6px;padding:3px 2px;font-size:.8rem;cursor:pointer}
    .multi-option-row input{margin-top:2px;flex-shrink:0}
    .multi-option-row span{flex:1;line-height:1.25}
    .multi-footer{margin-top:4px;font-size:.7rem;color:#6b7280;border-top:1px dashed #e5e7eb;padding-top:4px}
    .multi-empty{font-size:.8rem;color:#6b7280;padding:4px 2px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
    .modal-card{background:#fff;border-radius:18px;padding:20px 22px 18px;width:100%;max-width:420px;box-shadow:0 18px 40px rgba(15,23,42,.45);position:relative;max-height:90vh;overflow-y:auto}
    .modal-card h2{margin:0 0 6px 0;font-size:1.1rem;font-weight:600;color:#111827}
    .modal-card p{margin:0 0 14px 0;font-size:.85rem;color:#4b5563}
    .modal-buttons{margin-top:14px;display:flex;justify-content:flex-end;gap:8px}
    .btn-modal-cancel{border-radius:999px;border:none;padding:7px 16px;background:#e5e7eb;color:#374151;font-size:.82rem;cursor:pointer}
    .btn-modal-primary{border-radius:999px;border:none;padding:7px 18px;background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;font-size:.82rem;font-weight:500;cursor:pointer}
    .btn-close-modal{position:absolute;top:12px;right:12px;width:28px;height:28px;border-radius:50%;border:none;background:#f3f4f6;color:#6b7280;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1}
    .btn-close-modal:hover{background:#e5e7eb;color:#111827}
    .install-banner{display:none;position:fixed;bottom:0;left:0;right:0;background:linear-gradient(135deg,#047857,#059669);color:#fff;padding:14px 16px;box-shadow:0 -4px 20px rgba(0,0,0,.2);z-index:999}
    .install-banner.show{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .install-banner-text{font-size:.85rem;flex:1}
    .install-banner-text strong{display:block;font-size:.95rem;margin-bottom:2px}
    .btn-install{background:#fff;color:#047857;border:none;padding:8px 18px;border-radius:999px;font-size:.85rem;font-weight:600;cursor:pointer}
    .btn-dismiss{background:transparent;color:rgba(255,255,255,.8);border:1px solid rgba(255,255,255,.4);padding:6px 12px;border-radius:999px;font-size:.8rem;cursor:pointer}
    
    /* Radio buttons for jenis kelas */
    .radio-group{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
    .radio-option{display:flex;align-items:center;gap:6px;cursor:pointer}
    .radio-option input[type="radio"]{width:16px;height:16px;cursor:pointer}
    .radio-option label{margin:0;font-size:.85rem;cursor:pointer}
    
    /* Mata pelajaran field */
    .mp-field{margin-top:8px;display:none;padding:10px;background:#eff6ff;border-radius:10px;border:1px solid #bfdbfe}
    .mp-field.show{display:block}
    
    /* Checkbox inline style */
    .checkbox-inline{display:flex;align-items:center;gap:8px;margin-top:6px}
    .checkbox-inline input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
    .checkbox-inline label{margin:0;font-size:.85rem;cursor:pointer}
    
    /* Catatan keberadaan */
    .catatan-field{margin-top:8px;display:none}
    .catatan-field.show{display:block}
    .catatan-field label{color:#dc2626}
    
    /* ========================================= */
    /* NEW STYLES FOR ZOOM & FIXED TABLE SIZE    */
    /* ========================================= */
    
    /* Container for the zoomable table */
    .zoom-container {
      width: 100%;
      height: 70vh; /* Fixed viewport height */
      overflow: auto; /* Allow standard scrolling */
      background: #e5e7eb;
      border: 1px solid #ccc;
      position: relative;
      touch-action: pan-x pan-y pinch-zoom; /* Allow scrolling and pinch zoom */
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }
    
    /* Content wrapper to be transformed */
    .zoom-content {
      transform-origin: 0 0;
      width: fit-content;
      transition: transform 0.05s linear; /* Smoothness */
    }

    /* Fixed Layout Table Styles */
    #allClassSchedule {
      table-layout: fixed; /* STRICT FIXED LAYOUT */
      width: 1600px; /* FIXED TOTAL WIDTH */
      border-collapse: collapse;
      background: #fff;
    }

    #allClassSchedule th {
      border: 2px solid #000;
      text-align: center;
      padding: 4px;
      font-size: 0.75rem;
      line-height: 1.2;
      width: 110px; /* Fixed column width */
      overflow: hidden;
      white-space: normal;
      background: #047857;
      color: #fff;
    }
    
    /* Special width for 'Kelas' column */
    #allClassSchedule th:first-child {
      width: 70px; 
    }

    #allClassSchedule td {
      border: 2px solid #000;
      text-align: center;
      padding: 4px;
      width: 110px; /* Match header */
      height: 80px; /* FIXED ROW HEIGHT */
      max-height: 80px; /* Force limit */
      overflow: hidden; /* Hide overflow content */
      font-size: 0.7rem;
      vertical-align: top;
      cursor: pointer;
      word-wrap: break-word; /* Wrap text if possible */
    }
    
    /* Special width for 'Kelas' column data */
    #allClassSchedule td:first-child {
      width: 70px;
      vertical-align: middle;
      font-weight: 600;
      background: #f0fdf4;
    }

    /* Internal Cell Elements */
    #allClassSchedule .waktu-code{display:block;font-weight:600;font-size:0.8rem}
    #allClassSchedule .waktu-time{display:block;font-weight:400;font-size:0.65rem;opacity:0.9}
    #allClassSchedule .cell-empty{background-color:#fef9c3;color:#854d0e}
    #allClassSchedule .cell-filled{background-color:#fff}
    #allClassSchedule .cell-multi{background-color:#f0fdf4}
    #allClassSchedule .cell-rehat{background-color:#059669;color:#fff;font-weight:600;cursor:default;vertical-align:middle;}
    #allClassSchedule .guru-name{font-weight:600;color:#111827;display:block;font-size:0.7rem;white-space: normal; line-height:1.1;}
    #allClassSchedule .guru-tempat{font-size:0.6rem;color:#6b7280;display:block; margin-top:2px;}
    #allClassSchedule .guru-ganti-badge{font-size:0.55rem;background:#fbbf24;color:#78350f;padding:1px 3px;border-radius:3px;display:inline-block}
    #allClassSchedule .multi-record{border-bottom:1px dashed #d1d5db;padding:2px 0;margin-bottom:2px}
    #allClassSchedule .multi-record:last-child{border-bottom:none;margin-bottom:0}
    
    /* Detail Popup Card */
    .detail-popup .info-row{font-size:0.82rem;color:#374151;margin-bottom:6px;padding:6px 0;border-bottom:1px dashed #e5e7eb}
    .detail-popup .info-row:last-child{border-bottom:none}
    .detail-popup .info-row strong{color:#111827;display:inline-block;min-width:100px}
    .detail-popup .record-section{margin-bottom:12px;padding:12px;background:#f9fafb;border-radius:10px;border-left:4px solid #047857}
    .detail-popup .record-section.bc{border-left-color:#2563eb;background:#eff6ff}
    .detail-popup .record-section.ba{border-left-color:#db2777;background:#fdf2f8}
    .detail-popup .record-section.pemulihan{border-left-color:#059669;background:#ecfdf5}
    .detail-popup .sahsiah-section{margin-top:12px;padding:10px;background:#fef3c7;border-radius:10px}
    .detail-popup .sahsiah-section.baik{background:#dcfce7}
    .detail-popup .sahsiah-section.jahat{background:#fee2e2}
    
    /* Admin Panel Styles */
    .sahsiah-card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
    .sahsiah-card.is-confirmed {background:#f3f4f6; border-color: #e5e7eb; opacity: 0.8;}
    .sahsiah-card .header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
    .sahsiah-card .badge{font-size:0.7rem;padding:3px 8px;border-radius:999px;font-weight:500}
    .sahsiah-card .badge-baik{background:#dcfce7;color:#166534}
    .sahsiah-card .badge-jahat{background:#fee2e2;color:#991b1b}
    .sahsiah-card .badge-pending{background:#fef3c7;color:#92400e}
    .sahsiah-card .badge-confirmed{background:#e0e7ff;color:#3730a3}
    .sahsiah-card .info-row{font-size:0.78rem;color:#4b5563;margin-bottom:4px}
    .sahsiah-card .info-row strong{color:#111827}
    .sahsiah-card .murid-list{font-size:0.75rem;color:#6b7280;background:#f9fafb;padding:6px 8px;border-radius:8px;margin-top:6px}
  </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
<div class="app-shell">
  <div class="app-card">
    <div class="logo-wrap">
      <img id="sksaLogo" src="https://i.imgur.com/AfsVtVG.png" alt="Logo SKSA" />
      <span id="notifBadge">!</span>
      <h1>REKOD PEMANTAUAN KELAS SKSA</h1>
    </div>

    <div class="status-row">
      <div class="status-pill"><span id="headerTarikh">--/--/----</span></div>
      <div class="status-pill"><span id="headerMasa">--:--:--</span></div>
      <div class="status-pill"><span id="headerWaktu">Luar Waktu PdP</span></div>
    </div>

    <!-- PUBLIC VIEW CONTAINER -->
    <div id="publicView">
      <div class="tab-row">
        <button id="subTabForm" class="tab-btn active">ISI REKOD</button>
        <button id="subTabToday" class="tab-btn">REKOD HARI INI</button>
      </div>

      <!-- Form (Default View) -->
      <div id="rekodFormView">
        <div class="input-card">
          <div class="field">
            <label class="required">Nama Guru</label>
            <input type="text" id="namaGuru" placeholder="Contoh: Cikgu Sufian" />
            <div class="checkbox-inline">
              <input type="checkbox" id="guruGanti" />
              <label for="guruGanti">Guru Ganti</label>
            </div>
          </div>
          
          <div class="field">
            <label class="required">Jenis Kelas</label>
            <div class="radio-group">
              <div class="radio-option">
                <input type="radio" id="jenisKelasP" name="jenisKelas" value="penuh" checked />
                <label for="jenisKelasP">Kelas Penuh</label>
              </div>
              <div class="radio-option">
                <input type="radio" id="jenisKelasC" name="jenisKelas" value="pecahan" />
                <label for="jenisKelasC">Kelas Pecahan</label>
              </div>
            </div>
            <div class="mp-field" id="mpField">
              <label class="required">Mata Pelajaran</label>
              <select id="mataPelajaran">
                <option value="">Sila Pilih</option>
                <option value="BC">Bahasa Cina (BC)</option>
                <option value="BA">Bahasa Arab (BA)</option>
                <option value="PEMULIHAN">Pemulihan</option>
              </select>
            </div>
          </div>
          
          <div class="field">
            <label class="required">Kelas</label>
            <select id="kelas"><option value="">Sila Pilih</option></select>
          </div>
          <div class="field">
            <label class="required">Tempat</label>
            <select id="tempat">
              <option value="">Sila Pilih</option>
              <option value="KELAS">KELAS</option>
              <option value="MAKMAL KOMPUTER">MAKMAL KOMPUTER</option>
              <option value="KANTIN">KANTIN</option>
              <option value="SURAU">SURAU</option>
              <option value="DEWAN">DEWAN</option>
              <option value="BILIK JQAF">BILIK JQAF</option>
              <option value="BILIK MUZIK">BILIK MUZIK</option>
              <option value="BILIK BC">BILIK BC</option>
              <option value="BILIK BA">BILIK BA</option>
              <option value="BILIK PEMULIHAN">BILIK PEMULIHAN</option>
              <option value="LAIN-LAIN">LAIN-LAIN</option>
            </select>
          </div>
          <div class="field">
            <label class="required">Waktu Mengajar</label>
            <select id="waktuMengajar">
              <option value="1">1 Waktu</option>
              <option value="2">2 Waktu</option>
              <option value="3">3 Waktu</option>
              <option value="4">4 Waktu</option>
            </select>
            <div id="waktuPreview" class="kehadiran-subtext">Rekod akan diisi: -</div>
          </div>
          <div class="field">
            <label class="required">Jumlah Murid</label>
            <div class="inline-count">
              <input type="number" id="jumlahMurid" min="0" placeholder="Contoh: 28" />
              <span id="kehadiranRatio" class="kehadiran-ratio">/ -</span>
            </div>
            <div id="kehadiranSubtext" class="kehadiran-subtext">Kehadiran hari ini: -</div>
            <div class="catatan-field" id="catatanField">
              <label class="required">Catatan Keberadaan Murid Tidak Hadir</label>
              <textarea id="catatanKeberadaan" placeholder="Contoh: Ali - perjumpaan pengawas, Siti - ke bilik kesihatan"></textarea>
            </div>
          </div>
          <button class="btn-submit" id="btnSave">HANTAR</button>
        </div>

        <div class="section-title">Maklumat Sahsiah Murid (tidak wajib)</div>
        <div class="input-card">
          <div class="field">
            <label>Nama Murid</label>
            <div class="multi-select" id="namaMuridWrapper">
              <input type="text" id="namaMuridDisplay" placeholder="Pilih murid yang terlibat" readonly />
              <div id="namaMuridDropdown" class="multi-dropdown" style="display:none;">
                <div id="namaMuridOptions"></div>
                <div class="multi-footer">* Senarai murid berdasarkan kelas yang dipilih.</div>
              </div>
            </div>
          </div>

          <div class="toggle-row">
            <button type="button" class="toggle-btn active" id="btnGood">Amalan Baik</button>
            <button type="button" class="toggle-btn" id="btnBad">Kesalahan Disiplin</button>
          </div>

          <div id="panelGood">
            <div class="field">
              <label>Kategori Amalan Baik</label>
              <select id="amalanBaik">
                <option value="">Sila Pilih</option>
                <option value="Adab dan Berbudi Bahasa">ADAB DAN BERBUDI BAHASA</option>
                <option value="Akhlak Mulia">AKHLAK MULIA</option>
                <option value="Kebersihan Diri & Persekitaran">KEBERSIHAN DIRI & PERSEKITARAN</option>
                <option value="Keselamatan Diri">KESELAMATAN DIRI</option>
              </select>
            </div>
            <div class="field">
              <label>Perincian Amalan</label>
              <select id="perincianAmalan">
                <option value="">Sila Pilih</option>
                <option value="Menghargai Diri">MENGHARGAI DIRI</option>
                <option value="Menghormati Guru & Rakan">MENGHORMATI GURU & RAKAN</option>
                <option value="Berkelakuan Sopan">BERKELAKUAN SOPAN</option>
                <option value="Menjaga Kebersihan Kelas">MENJAGA KEBERSIHAN KELAS</option>
                <option value="Menjalankan Tugas yang Diamanahkan">MENJALANKAN TUGAS YANG DIAMANAHKAN</option>
              </select>
            </div>
            <div class="field">
              <label>Keterangan Amalan</label>
              <textarea id="keteranganAmalan" placeholder="Contoh: Menolong rakan yang kesusahan tanpa diminta."></textarea>
            </div>
          </div>

          <div id="panelBad" style="display:none;">
            <div class="field">
              <label>Kategori Kes</label>
              <select id="kategoriKes">
                <option value="">Sila Pilih</option>
                <option value="Barang Larangan">BARANG LARANGAN</option>
                <option value="Kekemasan Diri">KEKEMASAN DIRI</option>
                <option value="Kenakalan">KENAKALAN</option>
                <option value="Ponteng / Lewat Hadir">PONTENG / LEWAT HADIR</option>
                <option value="Kes Khas">KES KHAS</option>
                <option value="Kesalahan Asrama">KESALAHAN ASRAMA</option>
              </select>
            </div>
            <div class="field">
              <label>Punca / Ringkasan Salah Laku</label>
              <input type="text" id="puncaKes" placeholder="Contoh: Membawa telefon bimbit tanpa kebenaran." />
            </div>
            <div class="field">
              <label>Keterangan Kes</label>
              <textarea id="keteranganKes" placeholder="Contoh: Didapati menggunakan telefon bimbit di dalam kelas."></textarea>
            </div>
          </div>

          <div class="btn-row">
            <button type="button" class="btn-secondary" id="btnClearForm">Reset Semua</button>
          </div>
        </div>
      </div>

      <!-- Rekod Hari Ini -->
      <div id="rekodTodayView" style="display:none;">
        <div class="section-title">Jadual Guru Mengikut Waktu (Semua Kelas - Hari Ini)</div>
        <div style="font-size: 0.75rem; color: #666; margin-bottom: 5px;">
           <small>Gunakan dua jari untuk zoom in/out.</small>
        </div>
        <!-- Zoom Container -->
        <div id="zoomContainer" class="zoom-container">
          <div id="zoomContent" class="zoom-content">
            <table id="allClassSchedule">
              <thead id="allClassHead">
                <tr style="background:#047857; color:white;">
                  <th>Kelas</th>
                </tr>
              </thead>
              <tbody id="allClassBody">
                <tr><td colspan="14" style="text-align:center;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div style="margin-top:10px;font-size:0.7rem;color:#6b7280;">
          <span class="pill-mp pill-bc">BC</span> Bahasa Cina &nbsp;
          <span class="pill-mp pill-ba">BA</span> Bahasa Arab &nbsp;
          <span class="pill-mp pill-pemulihan">PEM</span> Pemulihan
        </div>
      </div>
    </div>
    
    <!-- ADMIN VIEW CONTAINER -->
    <div id="adminView" style="display:none;">
      <div class="admin-header">
         <div class="admin-title">üîê Panel Admin</div>
         <button class="btn-exit-admin" id="btnExitAdmin">Keluar</button>
      </div>

      <div class="admin-controls">
         <label for="adminFunctionSelect">Pilih Fungsi Admin:</label>
         <select id="adminFunctionSelect" class="admin-select">
            <option value="sahsiah">Semak Laporan Sahsiah</option>
            <option value="semakRekod">Semak Rekod Kehadiran</option>
         </select>
      </div>

      <!-- Content: Semak Laporan Sahsiah -->
      <div id="adminSahsiahContainer">
        <div class="section-title">Rekod Sahsiah Murid</div>
        <p style="font-size:0.8rem;color:#6b7280;margin-bottom:12px;">Klik 'Sahkan' untuk menyemak laporan baru.</p>
        <div id="adminSahsiahList">
          <div class="empty-state">Loading...</div>
        </div>
      </div>

      <!-- Content: Semak Rekod (Moved from Main Tab) -->
      <div id="adminSemakContainer" style="display:none;">
        <div class="section-title">Semak Rekod Mengikut Tarikh & Kelas</div>
        <div class="input-card">
          <div class="field">
            <label class="required">Tarikh</label>
            <input type="date" id="semakTarikh" />
          </div>
          <div class="field">
            <label class="required">Kelas</label>
            <select id="semakKelas"><option value="">Sila Pilih</option></select>
          </div>
          <button class="btn-submit" style="margin-top:4px;" id="btnSemakLoad">SEMAK REKOD</button>
          <div id="semakSummary" class="empty-state">Sila pilih tarikh dan kelas untuk semak rekod.</div>
        </div>

        <div class="section-title">Jadual Guru Mengikut Waktu</div>
        <div class="table-wrapper" id="semakTableWrapper" style="display:none;">
          <table>
            <thead><tr id="semakHeadRow"></tr></thead>
            <tbody><tr id="semakBodyRow"></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Admin Login Modal -->
<div id="adminLoginModal" class="modal-backdrop">
  <div class="modal-card">
    <h2>üîê Login Admin</h2>
    <p>Masukkan kata laluan untuk akses panel admin.</p>
    <div class="field">
      <input type="password" id="adminPassword" placeholder="Kata laluan" />
    </div>
    <div class="modal-buttons">
      <button type="button" class="btn-modal-cancel" id="adminCancelBtn">Batal</button>
      <button type="button" class="btn-modal-primary" id="adminLoginBtn">Login</button>
    </div>
  </div>
</div>

<!-- Detail Popup Modal -->
<div id="detailPopupModal" class="modal-backdrop">
  <div class="modal-card detail-popup">
    <button type="button" class="btn-close-modal" id="closeDetailPopup">&times;</button>
    <h2 id="detailPopupTitle">Maklumat Rekod</h2>
    <div id="detailPopupContent"></div>
  </div>
</div>

<!-- Install Banner -->
<div id="installBanner" class="install-banner">
  <div class="install-banner-text">
    <strong>Pasang Aplikasi</strong>
    Muat turun untuk akses lebih pantas
  </div>
  <button class="btn-install" id="btnInstall">Pasang</button>
  <button class="btn-dismiss" id="btnDismiss">Nanti</button>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="database.js"></script>

<script>
// =====================================================
// GLOBAL VARIABLES & HELPERS
// =====================================================
let isAdminLoggedIn = false;
const ADMIN_PASSWORD = "admin123";

const periods = [
  {code:"W1",start:"7.40",end:"8.10"},
  {code:"W2",start:"8.10",end:"8.40"},
  {code:"W3",start:"8.40",end:"9.10"},
  {code:"W4",start:"9.10",end:"9.40"},
  {code:"W5",start:"9.40",end:"10.10"},
  {code:"W6",start:"10.10",end:"10.40"},
  {code:"W7",start:"10.40",end:"11.10"},
  {code:"W8",start:"11.10",end:"11.40"},
  {code:"W9",start:"11.40",end:"12.10"},
  {code:"W10",start:"12.10",end:"12.40"},
  {code:"W11",start:"12.40",end:"13.10"},
  {code:"W12",start:"13.10",end:"13.40"},
  {code:"W13",start:"13.40",end:"14.10"}
];
const TOTAL_WAKTU = 13;

function getRehatWaktu(kelas) {
  const tahun = kelas.charAt(0);
  if (['1', '2', '3'].includes(tahun)) return 'W5';
  if (['4', '5', '6'].includes(tahun)) return 'W7';
  return null;
}

function timeToMinutes(str) {
  const [h, m] = str.split(".").map(Number);
  return h * 60 + m;
}

function formatDate(d) {
  return String(d.getDate()).padStart(2, "0") + "/" + 
         String(d.getMonth() + 1).padStart(2, "0") + "/" + 
         d.getFullYear();
}

function formatDateKey(d) {
  return d.getFullYear() + "-" + 
         String(d.getMonth() + 1).padStart(2, "0") + "-" + 
         String(d.getDate()).padStart(2, "0");
}

function formatTime(d) {
  return String(d.getHours()).padStart(2, "0") + ":" + 
         String(d.getMinutes()).padStart(2, "0") + ":" + 
         String(d.getSeconds()).padStart(2, "0");
}

function getCurrentPeriod(now) {
  const mn = now.getHours() * 60 + now.getMinutes();
  for (const p of periods) {
    const s = timeToMinutes(p.start), e = timeToMinutes(p.end);
    if (mn >= s && mn < e) return p;
  }
  return null;
}

function updateDateTimeUI() {
  const now = new Date();
  document.getElementById("headerTarikh").textContent = formatDate(now);
  document.getElementById("headerMasa").textContent = formatTime(now);
  const p = getCurrentPeriod(now);
  document.getElementById("headerWaktu").textContent = p ? p.code : "Luar Waktu PdP";
  updateWaktuPreview();
}

function updateWaktuPreview() {
  const waktuPreview = document.getElementById("waktuPreview");
  if (!waktuPreview) return;
  
  const now = new Date();
  const p = getCurrentPeriod(now);
  const waktuMengajar = parseInt(document.getElementById("waktuMengajar")?.value) || 1;
  
  if (!p) {
    waktuPreview.textContent = "Rekod akan diisi: Luar waktu PdP";
    return;
  }
  
  const startIndex = parseInt(p.code.replace('W', '')) - 1;
  const waktuList = [];
  
  for (let i = 0; i < waktuMengajar && (startIndex + i) < TOTAL_WAKTU; i++) {
    waktuList.push("W" + (startIndex + 1 + i));
  }
  
  if (waktuList.length > 0) {
    waktuPreview.textContent = "Rekod akan diisi: " + waktuList.join(", ");
    waktuPreview.style.color = "#047857";
  } else {
    waktuPreview.textContent = "Rekod akan diisi: -";
  }
}

// =====================================================
// SERVICE WORKER & PWA
// =====================================================
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('SW registered'))
      .catch(err => console.log('SW failed:', err));
  });
}

let deferredPrompt;
const installBanner = document.getElementById('installBanner');
const btnInstall = document.getElementById('btnInstall');
const btnDismiss = document.getElementById('btnDismiss');

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBanner.classList.add('show');
});

btnInstall.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  installBanner.classList.remove('show');
});

btnDismiss.addEventListener('click', () => installBanner.classList.remove('show'));

// =====================================================
// NAVIGATION & VIEW CONTROLLER
// =====================================================
const publicView = document.getElementById("publicView");
const adminView = document.getElementById("adminView");

// Sub-tabs (Form vs Today)
const subTabForm = document.getElementById("subTabForm");
const subTabToday = document.getElementById("subTabToday");
const rekodFormView = document.getElementById("rekodFormView");
const rekodTodayView = document.getElementById("rekodTodayView");

function setSubTab(tab) {
  if (tab === "form") {
    subTabForm.classList.add("active");
    subTabToday.classList.remove("active");
    rekodFormView.style.display = "block";
    rekodTodayView.style.display = "none";
  } else {
    subTabForm.classList.remove("active");
    subTabToday.classList.add("active");
    rekodFormView.style.display = "none";
    rekodTodayView.style.display = "block";
    loadAllClassesToday();
  }
}

subTabForm.addEventListener("click", () => setSubTab("form"));
subTabToday.addEventListener("click", () => setSubTab("today"));

// =====================================================
// JENIS KELAS (PENUH / PECAHAN)
// =====================================================
const jenisKelasP = document.getElementById("jenisKelasP");
const jenisKelasC = document.getElementById("jenisKelasC");
const mpField = document.getElementById("mpField");

function updateJenisKelas() {
  if (jenisKelasC.checked) {
    mpField.classList.add("show");
  } else {
    mpField.classList.remove("show");
    document.getElementById("mataPelajaran").value = "";
  }
}

jenisKelasP.addEventListener("change", updateJenisKelas);
jenisKelasC.addEventListener("change", updateJenisKelas);

// =====================================================
// SAHSIAH TOGGLE
// =====================================================
const btnGood = document.getElementById("btnGood");
const btnBad = document.getElementById("btnBad");
const panelGood = document.getElementById("panelGood");
const panelBad = document.getElementById("panelBad");

function setMode(mode) {
  if (mode === "good") {
    btnGood.classList.add("active");
    btnBad.classList.remove("active");
    panelGood.style.display = "block";
    panelBad.style.display = "none";
  } else {
    btnGood.classList.remove("active");
    btnBad.classList.add("active");
    panelGood.style.display = "none";
    panelBad.style.display = "block";
  }
}

btnGood.addEventListener("click", () => setMode("good"));
btnBad.addEventListener("click", () => setMode("bad"));

// =====================================================
// MULTI-SELECT MURID
// =====================================================
const kelasSelect = document.getElementById("kelas");
const namaMuridDisplay = document.getElementById("namaMuridDisplay");
const namaMuridDropdown = document.getElementById("namaMuridDropdown");
const namaMuridOptions = document.getElementById("namaMuridOptions");
const namaMuridWrapper = document.getElementById("namaMuridWrapper");
let selectedMurids = [];

function updateNamaMuridDisplay() {
  if (selectedMurids.length === 0) {
    namaMuridDisplay.value = "";
  } else if (selectedMurids.length <= 2) {
    namaMuridDisplay.value = selectedMurids.join(", ");
  } else {
    namaMuridDisplay.value = selectedMurids.length + " murid dipilih";
  }
}

function rebuildNamaMuridOptions() {
  selectedMurids = [];
  updateNamaMuridDisplay();
  namaMuridOptions.innerHTML = "";
  const kelasVal = kelasSelect.value.trim();
  if (!kelasVal) {
    namaMuridOptions.innerHTML = '<div class="multi-empty">Sila pilih kelas terlebih dahulu.</div>';
    return;
  }
  
  // Check if kelas pecahan and load specific MP students
  const isPecahan = jenisKelasC.checked;
  const mp = document.getElementById("mataPelajaran").value;
  
  let path = "config/classes/classData/" + kelasVal;
  if (isPecahan && mp) {
    // Load from MP specific list if available - logic preserved from original
    // but simplified to fallback to main class list if MP specific list missing
    path = "config/mp/" + mp + "/" + kelasVal;
  }
  
  db.ref(path).once("value").then(snap => {
    let data = snap.val();
    if (!data) {
      // Fallback to class list
      return db.ref("config/classes/classData/" + kelasVal).once("value");
    }
    return Promise.resolve(snap);
  }).then(snap => {
    const data = snap.val();
    if (!data) {
      namaMuridOptions.innerHTML = '<div class="multi-empty">Tiada data murid.</div>';
      return;
    }
    const senarai = Object.values(data);
    if (!senarai.length) {
      namaMuridOptions.innerHTML = '<div class="multi-empty">Tiada data murid.</div>';
      return;
    }
    senarai.forEach(name => {
      const row = document.createElement("label");
      row.className = "multi-option-row";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.value = name;
      cb.addEventListener("change", () => {
        if (cb.checked) {
          if (!selectedMurids.includes(name)) selectedMurids.push(name);
        } else {
          selectedMurids = selectedMurids.filter(n => n !== name);
        }
        updateNamaMuridDisplay();
      });
      const span = document.createElement("span");
      span.textContent = name;
      row.appendChild(cb);
      row.appendChild(span);
      namaMuridOptions.appendChild(row);
    });
  }).catch(() => {
    namaMuridOptions.innerHTML = '<div class="multi-empty">Ralat semasa ambil data murid.</div>';
  });
}

kelasSelect.addEventListener("change", () => {
  rebuildNamaMuridOptions();
  loadKehadiranForKelas();
});

document.getElementById("mataPelajaran").addEventListener("change", rebuildNamaMuridOptions);

namaMuridDisplay.addEventListener("click", () => {
  const h = namaMuridDropdown.style.display === "none" || namaMuridDropdown.style.display === "";
  namaMuridDropdown.style.display = h ? "block" : "none";
});

document.addEventListener("click", e => {
  if (!namaMuridWrapper.contains(e.target)) namaMuridDropdown.style.display = "none";
});

// =====================================================
// LOAD KEHADIRAN (Optimized: reads from 'kehadiran' node)
// =====================================================
let presentMuridKelas = 0;
let totalMuridKelas = 0;

function loadKehadiranForKelas() {
  const kelasVal = kelasSelect.value.trim();
  const ratioEl = document.getElementById("kehadiranRatio");
  const subtextEl = document.getElementById("kehadiranSubtext");
  const catatanField = document.getElementById("catatanField");
  
  if (!kelasVal) {
    ratioEl.textContent = "/ -";
    subtextEl.textContent = "Kehadiran hari ini: -";
    catatanField.classList.remove("show");
    presentMuridKelas = 0;
    totalMuridKelas = 0;
    return;
  }
  
  const todayKey = formatDateKey(new Date()); // YYYY-MM-DD
  
  // Read specific daily stats for this class from 'kehadiran'
  db.ref("kehadiran/" + todayKey + "/" + kelasVal).once("value").then(snap => {
    const data = snap.val();
    if (data && data.present !== undefined) {
      presentMuridKelas = data.present;
      totalMuridKelas = data.total;
      ratioEl.textContent = "/ " + presentMuridKelas;
      subtextEl.textContent = "Hadir: " + presentMuridKelas + " / " + totalMuridKelas;
    } else {
      // Fallback: Check 'kawalan' if 'kehadiran' summary isn't built yet
      checkKawalanFallback(kelasVal);
    }
  }).catch(err => {
    console.error(err);
    checkKawalanFallback(kelasVal);
  });
}

function checkKawalanFallback(kelasVal) {
  const ratioEl = document.getElementById("kehadiranRatio");
  const subtextEl = document.getElementById("kehadiranSubtext");
  const todayDate = formatDate(new Date()); // DD/MM/YYYY
  
  db.ref("kawalan").orderByChild("tarikh").equalTo(todayDate).once("value").then(snap => {
     let found = null;
     const data = snap.val();
     if (data) {
        const keys = Object.keys(data);
        for(let key of keys) {
           if(data[key].kelas === kelasVal && data[key].jumlahMurid !== undefined) {
              found = data[key];
              break; // Take first found
           }
        }
     }
     
     if(found) {
        presentMuridKelas = found.jumlahMurid;
        ratioEl.textContent = "/ " + presentMuridKelas;
        subtextEl.textContent = "Rekod terakhir: " + presentMuridKelas + " murid";
     } else {
        ratioEl.textContent = "/ -";
        subtextEl.textContent = "Kehadiran hari ini: Tiada rekod";
        presentMuridKelas = 0;
        totalMuridKelas = 0;
     }
  }).catch(() => {
     ratioEl.textContent = "/ -";
     subtextEl.textContent = "Tiada data";
     presentMuridKelas = 0;
  });
}

document.getElementById("jumlahMurid").addEventListener("input", function() {
  const jumlah = parseInt(this.value) || 0;
});

// =====================================================
// FORM HELPERS
// =====================================================
function hasSahsiahData() {
  const hasNama = selectedMurids.length > 0;
  const amalan = document.getElementById("amalanBaik").value;
  const perincian = document.getElementById("perincianAmalan").value;
  const ketAmalan = document.getElementById("keteranganAmalan").value.trim();
  const kategoriKes = document.getElementById("kategoriKes").value;
  const punca = document.getElementById("puncaKes").value.trim();
  const ketKes = document.getElementById("keteranganKes").value.trim();
  return !!(hasNama || amalan || perincian || ketAmalan || kategoriKes || punca || ketKes);
}

function clearForm() {
  document.getElementById("namaGuru").value = "";
  document.getElementById("guruGanti").checked = false;
  jenisKelasP.checked = true;
  mpField.classList.remove("show");
  document.getElementById("mataPelajaran").value = "";
  kelasSelect.value = "";
  document.getElementById("tempat").value = "";
  document.getElementById("waktuMengajar").value = "1";
  document.getElementById("jumlahMurid").value = "";
  document.getElementById("catatanKeberadaan").value = "";
  document.getElementById("catatanField").classList.remove("show");
  selectedMurids = [];
  updateNamaMuridDisplay();
  namaMuridOptions.innerHTML = "";
  document.getElementById("amalanBaik").value = "";
  document.getElementById("perincianAmalan").value = "";
  document.getElementById("keteranganAmalan").value = "";
  document.getElementById("kategoriKes").value = "";
  document.getElementById("puncaKes").value = "";
  document.getElementById("keteranganKes").value = "";
  document.getElementById("kehadiranRatio").textContent = "/ -";
  document.getElementById("kehadiranSubtext").textContent = "Kehadiran hari ini: -";
  presentMuridKelas = 0;
  totalMuridKelas = 0;
  updateWaktuPreview();
}

document.getElementById("btnClearForm").addEventListener("click", clearForm);
document.getElementById("waktuMengajar").addEventListener("change", updateWaktuPreview);

function saveRecordToFirebase(rec) {
  // Save to path: kawalan (Synched with JSON)
  const key = db.ref("kawalan").push().key;
  return db.ref("kawalan/" + key).set(rec);
}

function saveSahsiahRecord(record) {
  // Save to path: notifications (Pending sahsiah items go here based on JSON)
  const sahsiahData = {
    tarikh: record.tarikh,
    masa: record.masaRekod,
    kelas: record.kelas,
    tempat: record.tempat,
    namaGuru: record.namaGuru,
    namaMurid: record.namaMurid,
    jenis: record.jenis,
    kategori: record.kategori,
    keterangan: record.keterangan,
    status: "pending", 
    createdAt: Date.now()
  };
  db.ref("notifications").push(sahsiahData);
}

// =====================================================
// SAVE RECORD
// =====================================================
document.getElementById("btnSave").addEventListener("click", () => {
  const namaGuru = document.getElementById("namaGuru").value.trim();
  const guruGanti = document.getElementById("guruGanti").checked;
  const isPecahan = jenisKelasC.checked;
  const mataPelajaran = document.getElementById("mataPelajaran").value;
  const kelas = kelasSelect.value;
  const tempat = document.getElementById("tempat").value;
  const jumlahMurid = document.getElementById("jumlahMurid").value;
  const waktuMengajar = parseInt(document.getElementById("waktuMengajar").value) || 1;
  const catatanKeberadaan = document.getElementById("catatanKeberadaan").value.trim();
  
  if (!namaGuru || !kelas || !tempat || jumlahMurid === "") {
    alert("Sila lengkapkan Nama Guru, Kelas, Tempat dan Jumlah Murid.");
    return;
  }
  
  if (isPecahan && !mataPelajaran) {
    alert("Sila pilih Mata Pelajaran untuk kelas pecahan.");
    return;
  }
  
  const jumlah = parseInt(jumlahMurid) || 0;
  
  // For kelas penuh, check against presentMuridKelas
  if (!isPecahan && presentMuridKelas > 0 && jumlah < presentMuridKelas && !catatanKeberadaan) {
    alert("Sila nyatakan keberadaan " + (presentMuridKelas - jumlah) + " murid yang tidak berada dalam kelas.");
    return;
  }
  
  const now = new Date();
  const tarikh = formatDate(now);
  const masaRekod = formatTime(now);
  const p = getCurrentPeriod(now);
  const currentWaktuCode = p ? p.code : null;
  
  let startWaktuIndex = -1;
  if (currentWaktuCode) {
    startWaktuIndex = parseInt(currentWaktuCode.replace('W', '')) - 1;
  }
  
  if (startWaktuIndex < 0) {
    alert("Anda berada di luar waktu PdP. Sila rekod semasa waktu mengajar.");
    return;
  }
  
  if (startWaktuIndex + waktuMengajar > TOTAL_WAKTU) {
    alert("Waktu mengajar melebihi waktu yang tersedia.");
    return;
  }
  
  let jenis = null, kategori = "", keterangan = "", namaMuridText = "", namaMuridList = [];
  const adaSahsiah = hasSahsiahData();
  
  if (adaSahsiah) {
    if (selectedMurids.length === 0) {
      alert("Sila pilih sekurang-kurangnya seorang murid untuk rekod sahsiah.");
      return;
    }
    namaMuridList = selectedMurids.slice();
    namaMuridText = namaMuridList.join(", ");
    const isGood = btnGood.classList.contains("active");
    
    if (isGood) {
      const amalan = document.getElementById("amalanBaik").value;
      if (!amalan) {
        alert("Sila pilih kategori Amalan Baik.");
        return;
      }
      const perincian = document.getElementById("perincianAmalan").value;
      const ket = document.getElementById("keteranganAmalan").value.trim();
      jenis = "baik";
      kategori = perincian ? amalan + " - " + perincian : amalan;
      keterangan = ket;
    } else {
      const kategoriKes = document.getElementById("kategoriKes").value;
      if (!kategoriKes) {
        alert("Sila pilih Kategori Kes.");
        return;
      }
      const punca = document.getElementById("puncaKes").value.trim();
      const ketKes = document.getElementById("keteranganKes").value.trim();
      jenis = "jahat";
      kategori = kategoriKes;
      keterangan = [punca, ketKes].filter(Boolean).join(" | ");
    }
  }
  
  const waktuList = [];
  for (let i = 0; i < waktuMengajar; i++) {
    waktuList.push("W" + (startWaktuIndex + 1 + i));
  }
  
  const savePromises = waktuList.map(waktuCode => {
    const newRecord = {
      tarikh,
      waktu: waktuCode,
      masaRekod,
      namaGuru,
      kelas,
      tempat,
      guruGanti,
      jenisKelas: isPecahan ? "pecahan" : "penuh",
      mataPelajaran: isPecahan ? mataPelajaran : null,
      jumlahMurid: Number(jumlahMurid),
      presentMurid: presentMuridKelas || null,
      totalMurid: totalMuridKelas || null,
      waktuMengajar,
      waktuMula: waktuList[0],
      waktuAkhir: waktuList[waktuList.length - 1],
      catatanKeberadaan: catatanKeberadaan || null,
      namaMurid: namaMuridText || null,
      namaMuridList: namaMuridList.length ? namaMuridList : null,
      jenis, kategori, keterangan
    };
    return saveRecordToFirebase(newRecord);
  });
  
  Promise.all(savePromises).then(() => {
    if (adaSahsiah) {
      const sahsiahRec = {
        tarikh, waktu: waktuList.join(', '), masaRekod, namaGuru, kelas, tempat,
        namaMurid: namaMuridText, jenis, kategori, keterangan
      };
      saveSahsiahRecord(sahsiahRec);
    }
    const mpLabel = isPecahan ? " (" + mataPelajaran + ")" : "";
    alert("Rekod berjaya disimpan untuk " + waktuList.join(", ") + mpLabel);
    clearForm();
  }).catch(() => {
    alert("Gagal simpan rekod. Sila cuba lagi.");
  });
});

// =====================================================
// SEMAK REKOD (from kawalan)
// =====================================================
const semakTarikhInput = document.getElementById("semakTarikh");
const semakKelasSelect = document.getElementById("semakKelas");
const btnSemakLoad = document.getElementById("btnSemakLoad");
const semakSummary = document.getElementById("semakSummary");
const semakTableWrapper = document.getElementById("semakTableWrapper");
const semakHeadRow = document.getElementById("semakHeadRow");
const semakBodyRow = document.getElementById("semakBodyRow");

function dateInputToKey(val) {
  const parts = val.split("-");
  if (parts.length !== 3) return "";
  const [y, m, d] = parts;
  return d + "/" + m + "/" + y;
}

function buildHeadRow() {
  semakHeadRow.innerHTML = "";
  periods.forEach(p => {
    const th = document.createElement("th");
    th.innerHTML = p.code + "<br><small>" + p.start + "-" + p.end + "</small>";
    semakHeadRow.appendChild(th);
  });
}
buildHeadRow();

btnSemakLoad.addEventListener("click", () => {
  const t = semakTarikhInput.value;
  const k = semakKelasSelect.value;
  if (!t || !k) {
    alert("Sila pilih tarikh dan kelas.");
    return;
  }
  const tarikhKey = dateInputToKey(t);
  
  // Read from kawalan (Synced with JSON)
  db.ref("kawalan").orderByChild("tarikh").equalTo(tarikhKey).once("value").then(snap => {
    const data = snap.val();
    if (!data) {
      semakSummary.textContent = "Tiada rekod dijumpai.";
      semakTableWrapper.style.display = "none";
      return;
    }
    const rowsByW = {};
    periods.forEach(p => rowsByW[p.code] = []);
    Object.values(data).forEach(rec => {
      if (rec.kelas === k && rowsByW[rec.waktu]) rowsByW[rec.waktu].push(rec);
    });
    
    semakBodyRow.innerHTML = "";
    periods.forEach(p => {
      const td = document.createElement("td");
      const list = rowsByW[p.code];
      if (!list.length) {
        td.textContent = "-";
      } else {
        list.forEach(r => {
          const div = document.createElement("div");
          div.style.marginBottom = "4px";
          let mpBadge = "";
          if (r.mataPelajaran) {
            const mpClass = r.mataPelajaran === "BC" ? "pill-bc" : r.mataPelajaran === "BA" ? "pill-ba" : "pill-pemulihan";
            mpBadge = '<span class="pill-mp ' + mpClass + '">' + r.mataPelajaran + '</span>';
          }
          div.innerHTML = "<strong>" + r.namaGuru + "</strong>" + 
            (r.guruGanti ? ' <span class="pill-ganti">GANTI</span>' : '') +
            "<br>" + r.tempat + mpBadge;
          td.appendChild(div);
        });
      }
      semakBodyRow.appendChild(td);
    });
    semakSummary.textContent = "Rekod untuk " + k + " pada " + tarikhKey;
    semakTableWrapper.style.display = "block";
  });
});

// =====================================================
// DETAIL POPUP
// =====================================================
const detailPopupModal = document.getElementById("detailPopupModal");
const detailPopupTitle = document.getElementById("detailPopupTitle");
const detailPopupContent = document.getElementById("detailPopupContent");
const closeDetailPopup = document.getElementById("closeDetailPopup");

closeDetailPopup.addEventListener("click", () => detailPopupModal.style.display = "none");
detailPopupModal.addEventListener("click", (e) => {
  if (e.target === detailPopupModal) detailPopupModal.style.display = "none";
});

function showDetailPopup(records, kelas, waktu) {
  detailPopupTitle.textContent = "Maklumat Rekod - " + kelas + " (" + waktu + ")";
  
  let html = '';
  
  if (records.length === 0) {
    html = '<div class="info-row">Tiada rekod</div>';
  } else {
    records.forEach((record, idx) => {
      const mpClass = record.mataPelajaran === "BC" ? "bc" : record.mataPelajaran === "BA" ? "ba" : record.mataPelajaran === "PEMULIHAN" ? "pemulihan" : "";
      const sectionClass = mpClass ? "record-section " + mpClass : "record-section";
      
      let mpLabel = "";
      if (record.mataPelajaran) {
        mpLabel = " - " + (record.mataPelajaran === "BC" ? "Bahasa Cina" : record.mataPelajaran === "BA" ? "Bahasa Arab" : "Pemulihan");
      }
      
      html += '<div class="' + sectionClass + '">';
      if (records.length > 1) {
        html += '<div style="font-weight:600;margin-bottom:6px;color:#047857;">üìö Rekod ' + (idx + 1) + mpLabel + '</div>';
      }
      html += '<div class="info-row"><strong>üë®‚Äçüè´ Guru:</strong> ' + record.namaGuru + (record.guruGanti ? ' <span class="pill-ganti">GURU GANTI</span>' : '') + '</div>';
      html += '<div class="info-row"><strong>üìç Tempat:</strong> ' + record.tempat + '</div>';
      html += '<div class="info-row"><strong>üïê Masa:</strong> ' + record.masaRekod + '</div>';
      html += '<div class="info-row"><strong>üë• Murid:</strong> ' + record.jumlahMurid + ' orang</div>';
      
      if (record.catatanKeberadaan) {
        html += '<div class="info-row"><strong>üìù Catatan:</strong> ' + record.catatanKeberadaan + '</div>';
      }
      
      if (record.jenis) {
        const sahsiahClass = record.jenis === 'baik' ? 'baik' : 'jahat';
        const sahsiahLabel = record.jenis === 'baik' ? '‚úÖ Amalan Baik' : '‚ö†Ô∏è Kesalahan';
        html += '<div class="sahsiah-section ' + sahsiahClass + '">';
        html += '<strong>' + sahsiahLabel + '</strong><br>';
        html += 'Kategori: ' + (record.kategori || '-') + '<br>';
        if (record.keterangan) html += 'Keterangan: ' + record.keterangan + '<br>';
        if (record.namaMurid) html += 'Murid: ' + record.namaMurid;
        html += '</div>';
      }
      html += '</div>';
    });
  }
  
  detailPopupContent.innerHTML = html;
  detailPopupModal.style.display = "flex";
}

// =====================================================
// REKOD HARI INI - ALL CLASSES (from kawalan)
// =====================================================
let allRecordsToday = {};

function loadAllClassesToday() {
  const head = document.getElementById("allClassHead");
  const body = document.getElementById("allClassBody");
  if (!head || !body || typeof firebase === "undefined") return;
  
  // Header is static in HTML, but we check if we need to rebuild
  let headerHTML = '<tr style="background:#047857; color:white;"><th style="border:2px solid #000;">Kelas</th>';
  for (let i = 1; i <= TOTAL_WAKTU; i++) {
    const p = periods[i-1];
    headerHTML += '<th style="border:2px solid #000;"><span class="waktu-code">' + p.code + '</span><span class="waktu-time">' + p.start + '</span></th>';
  }
  headerHTML += '</tr>';
  head.innerHTML = headerHTML;
  
  const today = formatDate(new Date());
  body.innerHTML = '<tr><td colspan="' + (TOTAL_WAKTU + 1) + '" style="text-align:center;border:2px solid #000;">Loading...</td></tr>';
  
  db.ref("config/classes/classData").once("value").then(configSnap => {
    const allClasses = configSnap.val() ? Object.keys(configSnap.val()).sort() : [];
    
    // Read from kawalan (Synced with JSON)
    return db.ref("kawalan").orderByChild("tarikh").equalTo(today).once("value").then(snapshot => {
      body.innerHTML = "";
      
      const kelasMap = {};
      allRecordsToday = {};
      
      allClasses.forEach(kelas => {
        kelasMap[kelas] = {};
        for (let i = 1; i <= TOTAL_WAKTU; i++) {
          kelasMap[kelas]["W" + i] = [];
        }
      });
      
      if (snapshot.exists()) {
        snapshot.forEach(child => {
          const rec = child.val();
          if (!rec || !rec.kelas) return;
          
          const kelas = rec.kelas;
          const waktu = rec.waktu || "W1";
          
          if (!kelasMap[kelas]) {
            kelasMap[kelas] = {};
            for (let i = 1; i <= TOTAL_WAKTU; i++) {
              kelasMap[kelas]["W" + i] = [];
            }
          }
          
          kelasMap[kelas][waktu].push(rec);
          
          const key = kelas + "_" + waktu;
          if (!allRecordsToday[key]) allRecordsToday[key] = [];
          allRecordsToday[key].push(rec);
        });
      }
      
      const kelasList = Object.keys(kelasMap).sort();
      
      if (kelasList.length === 0) {
        body.innerHTML = '<tr><td colspan="' + (TOTAL_WAKTU + 1) + '" style="text-align:center;border:2px solid #000;">Tiada kelas didaftarkan</td></tr>';
        return;
      }
      
      kelasList.forEach(kelas => {
        const tr = document.createElement("tr");
        const rehatWaktu = getRehatWaktu(kelas);
        
        let row = '<td style="font-weight:600;background:#f0fdf4;text-align:center;border:2px solid #000;">' + kelas + '</td>';
        
        for (let i = 1; i <= TOTAL_WAKTU; i++) {
          const waktuKey = "W" + i;
          const records = kelasMap[kelas][waktuKey];
          
          if (waktuKey === rehatWaktu) {
            row += '<td class="cell-rehat" style="border:2px solid #000;cursor:default;">REHAT</td>';
          } else if (records && records.length > 0) {
            const cellClass = records.length > 1 ? "cell-multi" : "cell-filled";
            let cellContent = '';
            
            // Wrap content for fixed height handling
            cellContent += '<div class="cell-content-wrapper">';
            
            records.forEach((rec, idx) => {
              const mpBadge = rec.mataPelajaran ? 
                '<span class="pill-mp pill-' + rec.mataPelajaran.toLowerCase() + '">' + 
                (rec.mataPelajaran === "PEMULIHAN" ? "PEM" : rec.mataPelajaran) + '</span>' : '';
              const gantiHtml = rec.guruGanti ? '<span class="guru-ganti-badge">G</span>' : '';
              
              if (records.length > 1) {
                cellContent += '<div class="multi-record">';
              }
              cellContent += '<span class="guru-name">' + rec.namaGuru + '</span>' + gantiHtml;
              cellContent += '<span class="guru-tempat">' + rec.tempat + '</span>' + mpBadge;
              if (records.length > 1) {
                cellContent += '</div>';
              }
            });
            cellContent += '</div>';
            
            row += '<td class="' + cellClass + '" style="border:2px solid #000;" data-kelas="' + kelas + '" data-waktu="' + waktuKey + '">' + cellContent + '</td>';
          } else {
            row += '<td class="cell-empty" style="border:2px solid #000;">-</td>';
          }
        }
        
        tr.innerHTML = row;
        body.appendChild(tr);
      });
      
      // Add click listeners
      document.querySelectorAll('#allClassBody td[data-kelas]').forEach(td => {
        td.addEventListener('click', function() {
          const kelas = this.getAttribute('data-kelas');
          const waktu = this.getAttribute('data-waktu');
          const key = kelas + "_" + waktu;
          const records = allRecordsToday[key] || [];
          showDetailPopup(records, kelas, waktu);
        });
      });
    });
  }).catch(err => {
    console.error("Load error:", err);
    body.innerHTML = '<tr><td colspan="' + (TOTAL_WAKTU + 1) + '" style="text-align:center;border:2px solid #000;">Ralat memuat data</td></tr>';
  });
}

// =====================================================
// ADMIN PANEL LOGIC
// =====================================================

// Dropdown Controller
const adminFunctionSelect = document.getElementById("adminFunctionSelect");
const adminSahsiahContainer = document.getElementById("adminSahsiahContainer");
const adminSemakContainer = document.getElementById("adminSemakContainer");
const btnExitAdmin = document.getElementById("btnExitAdmin");

adminFunctionSelect.addEventListener("change", (e) => {
   const val = e.target.value;
   adminSahsiahContainer.style.display = "none";
   adminSemakContainer.style.display = "none";
   
   if(val === "sahsiah") {
      adminSahsiahContainer.style.display = "block";
      loadAllSahsiahRecords();
   } else if (val === "semakRekod") {
      adminSemakContainer.style.display = "block";
   }
});

function loadAllSahsiahRecords() {
  const container = document.getElementById("adminSahsiahList");
  if (!container) return;
  
  container.innerHTML = '<div class="empty-state">Loading...</div>';
  
  // Read from 'notifications' (Synced with JSON, where sahsiah items are stored)
  db.ref("notifications").orderByChild("createdAt").once("value").then(snap => {
    container.innerHTML = "";
    
    if (!snap.exists()) {
      container.innerHTML = '<div class="empty-state">Tiada rekod sahsiah.</div>';
      return;
    }
    
    const records = [];
    snap.forEach(child => records.push({ key: child.key, ...child.val() }));
    // Sort descending by time
    records.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
    
    records.forEach(r => {
      const card = document.createElement("div");
      // Add class for confirmed records to grey them out visually
      const isConfirmed = r.status === "confirmed";
      card.className = "sahsiah-card" + (isConfirmed ? " is-confirmed" : "");
      
      const jenisBadge = r.jenis === "baik" ? 
        '<span class="badge badge-baik">‚úì Amalan Baik</span>' : 
        '<span class="badge badge-jahat">‚úó Kesalahan</span>';
      
      const statusBadge = isConfirmed ?
        '<span class="badge badge-confirmed">Disahkan</span>' :
        '<span class="badge badge-pending">Menunggu</span>';
      
      card.innerHTML = 
        '<div class="header"><div>' + jenisBadge + ' ' + statusBadge + '</div></div>' +
        '<div class="info-row"><strong>üìÖ Tarikh:</strong> ' + (r.tarikh || "-") + '</div>' +
        '<div class="info-row"><strong>üïê Masa:</strong> ' + (r.masa || "-") + '</div>' +
        '<div class="info-row"><strong>üìç Tempat:</strong> ' + (r.tempat || "-") + '</div>' +
        '<div class="info-row"><strong>üè´ Kelas:</strong> ' + (r.kelas || "-") + '</div>' +
        '<div class="info-row"><strong>üë®‚Äçüè´ Guru:</strong> ' + (r.namaGuru || "-") + '</div>' +
        '<div class="info-row"><strong>üìù Kategori:</strong> ' + (r.kategori || "-") + '</div>' +
        (r.keterangan ? '<div class="info-row"><strong>üí¨ Keterangan:</strong> ' + r.keterangan + '</div>' : '') +
        '<div class="murid-list"><strong>üë§ Murid:</strong> ' + (r.namaMurid || "-") + '</div>' +
        (!isConfirmed ? 
          '<button onclick="sahkanLaporan(\'' + r.key + '\')" style="margin-top:8px;background:#047857;color:#fff;border:none;padding:6px 14px;border-radius:999px;font-size:0.75rem;cursor:pointer;">‚úì Sahkan</button>' : '');
      
      container.appendChild(card);
    });
  }).catch(err => {
    container.innerHTML = '<div class="empty-state" style="color:#dc2626;">Ralat memuat data.</div>';
  });
}

function sahkanLaporan(key) {
  if (!key) return;
  // Confirming updates status in notifications path
  db.ref("notifications/" + key + "/status").set("confirmed").then(() => {
     loadAllSahsiahRecords(); // Refresh list to update badge UI
  });
}
window.sahkanLaporan = sahkanLaporan;

// =====================================================
// LOAD KELAS FROM FIREBASE
// =====================================================
function loadKelasFromFirebase() {
  db.ref("config/classes/classData").once("value").then(snapshot => {
    const data = snapshot.val();
    if (!data) return;
    const classList = Object.keys(data).sort();
    kelasSelect.innerHTML = '<option value="">Sila Pilih</option>';
    semakKelasSelect.innerHTML = '<option value="">Sila Pilih</option>';
    classList.forEach(kls => {
      kelasSelect.innerHTML += '<option value="' + kls + '">' + kls + '</option>';
      semakKelasSelect.innerHTML += '<option value="' + kls + '">' + kls + '</option>';
    });
  }).catch(err => console.error("Gagal load kelas:", err));
}

// =====================================================
// ADMIN LOGIN & FLOW
// =====================================================
const sksaLogo = document.getElementById("sksaLogo");
const adminLoginModal = document.getElementById("adminLoginModal");
const adminLoginBtn = document.getElementById("adminLoginBtn");
const adminCancelBtn = document.getElementById("adminCancelBtn");
const adminPasswordInput = document.getElementById("adminPassword");
const notifBadge = document.getElementById("notifBadge");

function toggleAdminView(showAdmin) {
   if (showAdmin) {
      publicView.style.display = "none";
      adminView.style.display = "block";
      // Reset Admin View to default state
      adminFunctionSelect.value = "sahsiah";
      adminSahsiahContainer.style.display = "block";
      adminSemakContainer.style.display = "none";
      loadAllSahsiahRecords();
   } else {
      publicView.style.display = "block";
      adminView.style.display = "none";
   }
}

sksaLogo.addEventListener("click", () => {
  if (!isAdminLoggedIn) {
    adminLoginModal.style.display = "flex";
    adminPasswordInput.value = "";
    adminPasswordInput.focus();
  } else {
    toggleAdminView(true);
  }
});

adminCancelBtn.addEventListener("click", () => adminLoginModal.style.display = "none");

adminLoginBtn.addEventListener("click", () => {
  if (adminPasswordInput.value === ADMIN_PASSWORD) {
    isAdminLoggedIn = true;
    adminLoginModal.style.display = "none";
    toggleAdminView(true);
  } else {
    alert("Kata laluan salah!");
  }
});

adminPasswordInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") adminLoginBtn.click();
});

btnExitAdmin.addEventListener("click", () => {
   toggleAdminView(false);
});

function listenNotifications() {
  // Listen to notifications (sahsiah) status
  db.ref("notifications").on("value", snap => {
    const data = snap.val();
    let pendingCount = 0;
    
    if (data) {
      Object.values(data).forEach(item => {
         if(item.status === 'pending') pendingCount++;
      });
    }

    if (pendingCount > 0) {
      notifBadge.textContent = pendingCount;
      notifBadge.style.display = "block";
    } else {
      notifBadge.style.display = "none";
    }
  });
}

// =====================================================
// PINCH ZOOM LOGIC FOR TABLE
// =====================================================
const zoomContainer = document.getElementById('zoomContainer');
const zoomContent = document.getElementById('zoomContent');

if (zoomContainer && zoomContent) {
  let startScale = 1;
  let currentScale = 1;
  let initialDistance = 0;

  zoomContainer.addEventListener('touchstart', (e) => {
    if (e.touches.length === 2) {
      // Calculate initial distance between two fingers
      initialDistance = Math.hypot(
        e.touches[0].pageX - e.touches[1].pageX,
        e.touches[0].pageY - e.touches[1].pageY
      );
      startScale = currentScale;
    }
  }, { passive: false });

  zoomContainer.addEventListener('touchmove', (e) => {
    if (e.touches.length === 2) {
      e.preventDefault(); // Prevent default browser zoom behavior
      
      const newDistance = Math.hypot(
        e.touches[0].pageX - e.touches[1].pageX,
        e.touches[0].pageY - e.touches[1].pageY
      );
      
      const ratio = newDistance / initialDistance;
      
      // Limit zoom between 0.5x and 3x
      currentScale = Math.min(Math.max(0.5, startScale * ratio), 3);
      
      zoomContent.style.transform = `scale(${currentScale})`;
    }
  }, { passive: false });
}

// =====================================================
// INIT
// =====================================================
document.addEventListener("DOMContentLoaded", () => {
  setInterval(updateDateTimeUI, 1000);
  updateDateTimeUI();
  loadKelasFromFirebase();
  listenNotifications();
});
</script>

<script type="module" src="/index.tsx"></script>
</body>
</html>
